<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administrador</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos Customizados -->
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #2563eb; /* Tom de azul blueprint */
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.07) 1px, transparent 1px),
                linear-gradient(rgba(255, 255, 255, 0.05) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 2px, transparent 2px);
            background-size: 20px 20px, 20px 20px, 100px 100px, 100px 100px;
            background-position: -1px -1px, -1px -1px, -1px -1px, -1px -1px;
        }
        ::placeholder { color: #9ca3af; opacity: 1; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body>

    <!-- Container de Login do Admin -->
    <div id="admin-login-container" class="relative min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 space-y-6 border border-white/20">
            <h1 class="text-2xl font-bold text-white text-center">Acesso Restrito</h1>
            <p class="text-center text-gray-300 text-sm">Este painel é exclusivo para administradores.</p>
            <div id="admin-message-box" class="hidden p-3 rounded-lg text-center text-sm font-medium"></div>
            <form id="admin-login-form" class="space-y-6">
                <div>
                    <label for="admin-user" class="text-sm font-medium text-gray-300">Usuário</label>
                    <input type="text" id="admin-user" required class="mt-1 w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg" placeholder="Digite o usuário">
                </div>
                <div>
                    <label for="admin-password" class="text-sm font-medium text-gray-300">Senha</label>
                    <input type="password" id="admin-password" required class="mt-1 w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg" placeholder="Digite a senha">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Container do Painel Principal -->
    <div id="admin-panel-container" class="hidden relative p-4 md:p-8">
        <div class="w-full max-w-7xl mx-auto bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 space-y-8 border border-white/20">
            <!-- Cabeçalho -->
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-white">Painel Administrativo</h1>
                    <p id="admin-user-email" class="text-sm text-gray-300"></p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <button id="notifications-btn" class="text-white hover:text-gray-300 relative">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span id="notifications-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden">0</span>
                        </button>
                        <div id="notifications-list" class="absolute right-0 mt-8 w-80 bg-gray-800 border border-gray-600 rounded-lg shadow-lg z-10 hidden max-h-96 overflow-y-auto">
                            <!-- As notificações serão preenchidas aqui -->
                        </div>
                    </div>
                    <button id="admin-logout-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Sair</button>
                </div>
            </div>

            <!-- Menu Principal -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-center">
                <button id="manage-challenges-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-6 rounded-lg text-xl transition">Gerenciar Desafios</button>
                <button id="manage-shop-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-6 rounded-lg text-xl transition">Gerenciar Loja</button>
                <button id="manage-levels-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-6 rounded-lg text-xl transition">Gerenciar Níveis</button>
                <button id="view-users-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 rounded-lg text-xl transition">Visualizar Usuários</button>
            </div>

            <!-- Conteúdo Dinâmico -->
            <div id="dynamic-content" class="hidden bg-black/20 p-6 rounded-lg"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>


    <script type="module">
        // --- SDKs DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, query, orderBy, onSnapshot, where, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyAbUkp2kVA4GXD2qZz_zOQRyR7skqQUwFg",
          authDomain: "projects-debbb.firebaseapp.com",
          projectId: "projects-debbb",
          storageBucket: "projects-debbb.appspot.com",
          messagingSenderId: "1016788358282",
          appId: "1:1016788358282:web:491d260dfac9bc19f88973",
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- VARIÁVEIS GLOBAIS ---
        let allChallengesData = [];
        let unreadNotifications = [];

        // --- ELEMENTOS DO DOM ---
        const loginContainer = document.getElementById('admin-login-container');
        const panelContainer = document.getElementById('admin-panel-container');
        const messageBox = document.getElementById('admin-message-box');
        const dynamicContent = document.getElementById('dynamic-content');
        const modalContainer = document.getElementById('modal-container');
        const notificationsBtn = document.getElementById('notifications-btn');
        const notificationsCount = document.getElementById('notifications-count');
        const notificationsList = document.getElementById('notifications-list');

        // --- LOGIN DO ADMIN ---
        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('admin-user').value.trim() === 'admin' && document.getElementById('admin-password').value === 'admin') {
                loginContainer.classList.add('hidden');
                panelContainer.classList.remove('hidden');
                document.getElementById('admin-user-email').textContent = `Admin: admin`;
                listenForNotifications();
            } else {
                showAdminMessage('Usuário ou senha inválidos.', true);
            }
        });
        document.getElementById('admin-logout-button').addEventListener('click', () => {
            panelContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            dynamicContent.classList.add('hidden');
        });
        function showAdminMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = `p-3 rounded-lg text-center text-sm font-medium ${isError ? 'bg-red-500/50 text-red-100' : 'bg-green-500/50 text-green-100'}`;
        }
        
        // --- SISTEMA DE NOTIFICAÇÕES ---
        function listenForNotifications() {
            const q = query(collection(db, "purchaseNotifications"), where("read", "==", false));
            onSnapshot(q, (snapshot) => {
                unreadNotifications = snapshot.docs;
                const count = unreadNotifications.length;
                notificationsCount.textContent = count;
                if (count > 0) {
                    notificationsCount.classList.remove('hidden');
                } else {
                    notificationsCount.classList.add('hidden');
                }
            });
        }
        
        notificationsBtn.addEventListener('click', async () => {
            notificationsList.classList.toggle('hidden');
            if (!notificationsList.classList.contains('hidden')) {
                const q = query(collection(db, "purchaseNotifications"), orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);
                notificationsList.innerHTML = '';
                if (snapshot.empty) {
                     notificationsList.innerHTML = '<p class="text-gray-400 p-4 text-center text-sm">Nenhuma notificação.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const notif = doc.data();
                        const isUnread = !notif.read;
                        const div = document.createElement('div');
                        div.className = `p-3 border-b border-gray-700 ${isUnread ? 'bg-indigo-900/50' : ''}`;
                        div.innerHTML = `
                            <p class="text-sm text-white"><span class="font-bold">${notif.userEmail}</span> comprou <span class="font-bold">${notif.itemName}</span>.</p>
                            <p class="text-xs text-gray-400 mt-1">${new Date(notif.timestamp?.toDate()).toLocaleString()}</p>
                        `;
                        notificationsList.appendChild(div);
                    });
                }
                
                // Marcar como lidas
                unreadNotifications.forEach(doc => {
                    updateDoc(doc.ref, { read: true });
                });
            }
        });

        // --- NAVEGAÇÃO DO PAINEL ---
        document.getElementById('manage-challenges-btn').addEventListener('click', showChallengesManagement);
        document.getElementById('manage-shop-btn').addEventListener('click', showShopManagement);
        document.getElementById('manage-levels-btn').addEventListener('click', showLevelsManagement);
        document.getElementById('view-users-btn').addEventListener('click', showUsersManagement);

        // --- FUNÇÕES DE MODAL GENÉRICAS ---
        function createModal(id, title, content, maxWidth = 'max-w-xl') {
            const existingModal = document.getElementById(id);
            if(existingModal) existingModal.remove();

            const modalHtml = `
                <div id="${id}" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300">
                    <div class="modal-content w-full ${maxWidth} bg-gray-800 border border-gray-600 rounded-2xl shadow-xl p-6 transform scale-95 transition-transform duration-300">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">${title}</h2>
                            <button onclick="document.getElementById('${id}').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        ${content}
                    </div>
                </div>`;
            modalContainer.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById(id);
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        // --- GERENCIAMENTO DE DESAFIOS ---
        async function showChallengesManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-semibold text-white">Desafios Cadastrados</h2>
                    <div class="flex items-center gap-2 flex-wrap justify-end">
                        <input type="text" id="filter-name" placeholder="Filtrar por nome..." class="bg-gray-700 text-white p-2 rounded-lg border border-gray-600 text-sm">
                        <select id="filter-category" class="bg-gray-700 text-white p-2 rounded-lg border border-gray-600 text-sm">
                            <option value="">Todas as Categorias</option>
                        </select>
                        <button id="add-new-challenge-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 whitespace-nowrap text-sm">Adicionar Novo</button>
                    </div>
                </div>
                <div id="challenges-list" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>
            `;
            document.getElementById('add-new-challenge-btn').addEventListener('click', () => openChallengeModal());
            document.getElementById('filter-name').addEventListener('input', renderChallengesList);
            document.getElementById('filter-category').addEventListener('change', renderChallengesList);

            await fetchAllChallenges();
            renderChallengesList();
        }

        async function fetchAllChallenges() {
            const listEl = document.getElementById('challenges-list');
            if (listEl) listEl.innerHTML = '<p class="text-gray-400">Carregando desafios...</p>';
            const querySnapshot = await getDocs(collection(db, "challenges"));
            allChallengesData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function renderChallengesList() {
            const listEl = document.getElementById('challenges-list');
            if (!listEl) return;
            
            const categoryFilter = document.getElementById('filter-category');
            const categories = [...new Set(allChallengesData.map(c => c.category))];
            const currentCategorySelection = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">Todas as Categorias</option>'; 
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            categoryFilter.value = currentCategorySelection;

            const nameFilter = document.getElementById('filter-name').value.toLowerCase();
            const categoryFilterValue = categoryFilter.value;

            const filteredChallenges = allChallengesData.filter(challenge => {
                const nameMatch = challenge.name.toLowerCase().includes(nameFilter);
                const categoryMatch = !categoryFilterValue || challenge.category === categoryFilterValue;
                return nameMatch && categoryMatch;
            });

            listEl.innerHTML = '';
            if (filteredChallenges.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">Nenhum desafio encontrado com os filtros aplicados.</p>';
            } else {
                filteredChallenges.forEach(data => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    
                    let timeInfo = '';
                    const timeLimitInSeconds = parseInt(data.timeLimit) || 0;
                    if (timeLimitInSeconds > 0) {
                        const minutes = Math.floor(timeLimitInSeconds / 60);
                        const seconds = timeLimitInSeconds % 60;
                        let timeString = `${minutes}min`;
                        if (seconds > 0) {
                            timeString += ` ${seconds}s`;
                        }

                        timeInfo = `<span class="text-xs bg-cyan-500 text-white px-2 py-1 rounded-full ml-2 flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                                        ${timeString} (x${data.bonusMultiplier})
                                    </span>`;
                    }

                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="cursor-pointer" data-id="${data.id}" data-name="${data.name}">
                                <span class="text-white font-semibold">${data.name}</span>
                            </div>
                            <span class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-full">${data.category}</span>
                            <span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full">${data.score} pts</span>
                            ${timeInfo}
                        </div>
                        <div>
                            <button data-id="${data.id}" class="edit-challenge-btn bg-blue-600 text-white px-2 py-1 text-xs rounded hover:bg-blue-700 mr-2">Editar</button>
                            <button data-id="${data.id}" class="delete-challenge-btn bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Excluir</button>
                        </div>`;
                    listEl.appendChild(div);
                });
            }
            listEl.querySelectorAll('.delete-challenge-btn').forEach(btn => btn.addEventListener('click', deleteChallenge));
            listEl.querySelectorAll('.edit-challenge-btn').forEach(btn => btn.addEventListener('click', (e) => openChallengeModal(e.target.dataset.id)));
            listEl.querySelectorAll('.cursor-pointer').forEach(el => el.addEventListener('click', (e) => showChallengeImage(e.currentTarget.dataset.id, e.currentTarget.dataset.name)));
        }
        
        async function deleteChallenge(e) {
            const id = e.target.dataset.id;
            if (confirm(`Tem certeza que deseja excluir este desafio?`)) {
                await deleteDoc(doc(db, "challenges", id));
                await fetchAllChallenges();
                renderChallengesList();
            }
        }
        
        function showChallengeImage(id, name) {
            createModal('challenge-image-modal', name, `<img src="https://lh3.googleusercontent.com/d/${id}" class="w-full h-auto rounded-md">`, 'max-w-2xl');
        }

        async function openChallengeModal(challengeId = null) {
            const categories = [...new Set(allChallengesData.map(d => d.category).filter(Boolean))];
            const datalistHtml = categories.map(c => `<option value="${c}"></option>`).join('');
            
            createModal('challenge-modal', 'Gerenciar Desafio', `
                <form id="add-challenge-form" class="space-y-4">
                    <input type="hidden" id="challenge-id-hidden">
                    <input type="text" id="challenge-url" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Link completo do Arquivo no Google Drive">
                    <input type="text" id="challenge-name" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Nome do Desafio (Ex: Peça 135)">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <input type="text" id="challenge-category" list="categories-datalist" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Categoria">
                        <input type="number" step="1" id="challenge-score" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Pontuação" value="10">
                        <input type="number" step="any" id="challenge-tolerance" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Tolerância (%)" value="5">
                    </div>
                    <datalist id="categories-datalist">${datalistHtml}</datalist>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <input type="number" step="any" id="challenge-mass" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Massa (g)">
                        <input type="number" step="any" id="challenge-volume" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Volume (cm³)">
                        <input type="text" id="challenge-material" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Material">
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input type="number" step="any" id="challenge-timeLimit" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Tempo (minutos, opcional)">
                        <input type="number" step="0.1" id="challenge-bonusMultiplier" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Multiplicador de Bônus (ex: 1.5)">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Salvar Desafio</button>
                </form>
            `, 'max-w-xl');

            if (challengeId) {
                const docSnap = await getDoc(doc(db, "challenges", challengeId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('challenge-id-hidden').value = challengeId;
                    document.getElementById('challenge-url').value = `https://drive.google.com/file/d/${challengeId}/view`;
                    
                    if(data.timeLimit) {
                         document.getElementById('challenge-timeLimit').value = data.timeLimit / 60;
                    }

                    ['name', 'category', 'score', 'tolerance', 'mass', 'volume', 'material', 'bonusMultiplier'].forEach(key => {
                        const el = document.getElementById(`challenge-${key}`);
                        if (el && data[key] !== undefined) el.value = data[key];
                    });
                }
            }
            
            document.getElementById('add-challenge-form').addEventListener('submit', saveChallenge);
        }

        async function saveChallenge(e) {
            e.preventDefault();
            const url = document.getElementById('challenge-url').value;
            let id = document.getElementById('challenge-id-hidden').value;
            if (!id) id = url.match(/\/d\/(.*?)(?:\/|$)/)?.[1] || url;

            if (!id) return alert("URL do Google Drive inválida.");
            
            const timeInMinutes = parseFloat(document.getElementById('challenge-timeLimit').value) || 0;

            const data = {
                name: document.getElementById('challenge-name').value,
                category: document.getElementById('challenge-category').value,
                mass: document.getElementById('challenge-mass').value,
                volume: document.getElementById('challenge-volume').value,
                material: document.getElementById('challenge-material').value,
                tolerance: document.getElementById('challenge-tolerance').value,
                score: document.getElementById('challenge-score').value,
                timeLimit: timeInMinutes * 60,
                bonusMultiplier: document.getElementById('challenge-bonusMultiplier').value || 1.5,
            };
            await setDoc(doc(db, "challenges", id), data);
            document.getElementById('challenge-modal').remove();
            await fetchAllChallenges();
            renderChallengesList();
        }

        // --- GERENCIAMENTO DA LOJA ---
        async function showShopManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Itens da Loja</h2>
                    <button id="add-new-item-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Adicionar Novo Item</button>
                </div>
                <div id="shop-items-list" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>
            `;
            document.getElementById('add-new-item-btn').addEventListener('click', () => openShopItemModal());
            await loadShopItems();
        }

        async function loadShopItems() {
            const listEl = document.getElementById('shop-items-list');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const querySnapshot = await getDocs(collection(db, "shopItems"));
            listEl.innerHTML = '';

            if (querySnapshot.empty) {
                listEl.innerHTML = '<p class="text-gray-400">Nenhum item na loja.</p>';
            } else {
                const itemTypes = {
                    unico: 'Único',
                    multiplo: 'Múltiplo',
                    consumable_reroll: 'Consumível (Troca)',
                    consumable_choice: 'Consumível (Escolha)',
                };
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <span class="text-white font-semibold">${data.name}</span>
                            <span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full ml-2">${data.price} pts</span>
                            <span class="text-xs bg-purple-500 text-white px-2 py-1 rounded-full ml-2">${itemTypes[data.type] || 'Desconhecido'}</span>
                        </div>
                        <div>
                            <button data-id="${doc.id}" class="edit-item-btn bg-blue-600 text-white px-2 py-1 text-xs rounded hover:bg-blue-700 mr-2">Editar</button>
                            <button data-id="${doc.id}" class="delete-item-btn bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Excluir</button>
                        </div>`;
                    listEl.appendChild(div);
                });
            }
            document.querySelectorAll('.delete-item-btn').forEach(btn => btn.addEventListener('click', (e) => deleteDoc(doc(db, "shopItems", e.target.dataset.id)).then(loadShopItems)));
            document.querySelectorAll('.edit-item-btn').forEach(btn => btn.addEventListener('click', (e) => openShopItemModal(e.target.dataset.id)));
        }

        async function openShopItemModal(itemId = null) {
            createModal('shop-item-modal', 'Gerenciar Item da Loja', `
                <form id="add-item-form" class="space-y-4">
                    <input type="hidden" id="item-id-hidden">
                    <input type="text" id="item-name" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Nome do Item">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="item-price" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Preço (pontos)">
                        <select id="item-type" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg">
                            <option value="unico">Compra Única</option>
                            <option value="multiplo">Compra Múltipla</option>
                            <option value="consumable_reroll">Consumível (Trocar Desafio)</option>
                            <option value="consumable_choice">Consumível (Escolher Desafio)</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Salvar Item</button>
                </form>
            `);
            if (itemId) {
                const docSnap = await getDoc(doc(db, "shopItems", itemId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('item-id-hidden').value = itemId;
                    document.getElementById('item-name').value = data.name;
                    document.getElementById('item-price').value = data.price;
                    document.getElementById('item-type').value = data.type;
                }
            }
            document.getElementById('add-item-form').addEventListener('submit', saveShopItem);
        }

        async function saveShopItem(e) {
            e.preventDefault();
            let id = document.getElementById('item-id-hidden').value;
            const type = document.getElementById('item-type').value;

            if (type === 'consumable_reroll') id = 'reroll_token';
            else if (type === 'consumable_choice') id = 'choice_token';
            else if (!id) id = Date.now().toString();
            
            const data = {
                name: document.getElementById('item-name').value,
                price: parseInt(document.getElementById('item-price').value),
                type: type,
            };
            await setDoc(doc(db, "shopItems", id), data);
            document.getElementById('shop-item-modal').remove();
            await loadShopItems();
        }
        
        // --- GERENCIAMENTO DE NÍVEIS ---
        async function showLevelsManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Níveis de Experiência</h2>
                    <button id="add-new-level-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Adicionar Nível</button>
                </div>
                <div id="levels-list" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>
            `;
            document.getElementById('add-new-level-btn').addEventListener('click', openLevelModal);
            await loadLevels();
        }

        async function loadLevels() {
            const listEl = document.getElementById('levels-list');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const q = query(collection(db, "levels"), orderBy("xpRequired", "asc"));
            const querySnapshot = await getDocs(q);
            listEl.innerHTML = '';

            if (querySnapshot.empty) {
                listEl.innerHTML = '<p class="text-gray-400">Nenhum nível cadastrado. Crie o primeiro nível com 0 XP.</p>';
            } else {
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <span class="text-white font-semibold">${data.name}</span>
                            <span class="text-xs bg-cyan-500 text-white px-2 py-1 rounded-full ml-2">XP Mínimo: ${data.xpRequired}</span>
                        </div>
                        <button data-id="${doc.id}" class="delete-level-btn bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Excluir</button>
                    `;
                    listEl.appendChild(div);
                });
            }
            document.querySelectorAll('.delete-level-btn').forEach(btn => btn.addEventListener('click', (e) => deleteDoc(doc(db, "levels", e.target.dataset.id)).then(loadLevels)));
        }

        function openLevelModal() {
            createModal('level-modal', 'Adicionar Novo Nível', `
                <form id="add-level-form" class="space-y-4">
                    <input type="text" id="level-name" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Nome do Nível (ex: Aprendiz)">
                    <input type="number" id="level-xp" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="XP necessário para alcançar">
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Salvar Nível</button>
                </form>
            `);
            document.getElementById('add-level-form').addEventListener('submit', saveLevel);
        }

        async function saveLevel(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('level-name').value,
                xpRequired: parseInt(document.getElementById('level-xp').value),
            };
            const newDocRef = doc(collection(db, "levels"));
            await setDoc(newDocRef, data);
            document.getElementById('level-modal').remove();
            await loadLevels();
        }

        // --- VISUALIZAÇÃO DE USUÁRIOS ---
        async function showUsersManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `<h2 class="text-2xl font-semibold text-white mb-4">Usuários Cadastrados</h2>
                                        <div id="users-list" class="max-h-[30rem] overflow-y-auto space-y-2 pr-2"></div>`;
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '<p class="text-gray-400">Carregando...</p>';

            const usersSnapshot = await getDocs(query(collection(db, "users"), orderBy("xp", "desc")));
            usersList.innerHTML = '';
            if (usersSnapshot.empty) {
                usersList.innerHTML = '<p class="text-gray-400">Nenhum usuário cadastrado.</p>';
            } else {
                usersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center cursor-pointer hover:bg-gray-600';
                    div.innerHTML = `
                        <div>
                            <span class="text-white">${userData.email}</span>
                            <span class="text-sm text-cyan-400 ml-4">${userData.xp || 0} XP</span>
                        </div>
                        <span class="text-yellow-400 font-semibold">${userData.score || 0} pts</span>`;
                    div.addEventListener('click', () => showUserDetailsModal(userDoc.id, userData.email));
                    usersList.appendChild(div);
                });
            }
        }

        async function showUserDetailsModal(userId, email) {
            createModal('user-details-modal', `Detalhes de ${email}`, `
                <div class="border-b border-gray-600 mb-4">
                    <nav class="flex -mb-px">
                        <button data-tab="attempts" class="tab-btn border-b-2 border-indigo-500 text-white py-2 px-4">Tentativas</button>
                        <button data-tab="purchases" class="tab-btn border-b-2 border-transparent text-gray-400 py-2 px-4">Itens Comprados</button>
                    </nav>
                </div>
                <div id="tab-content-attempts" class="tab-content max-h-[60vh] overflow-y-auto space-y-4 pr-2"></div>
                <div id="tab-content-purchases" class="tab-content hidden max-h-[60vh] overflow-y-auto space-y-2 pr-2"></div>
            `, 'max-w-4xl');
            
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.addEventListener('click', (e) => {
                tabs.forEach(t => t.classList.remove('border-indigo-500', 'text-white'));
                e.target.classList.add('border-indigo-500', 'text-white');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-content-${e.target.dataset.tab}`).classList.remove('hidden');
            }));

            await loadUserAttempts(userId);
            await loadUserPurchases(userId);
        }

        async function loadUserAttempts(userId) {
            const listEl = document.getElementById('tab-content-attempts');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            
            const challengesSnapshot = await getDocs(collection(db, "challenges"));
            const allChallengesInfo = new Map();
            challengesSnapshot.forEach(doc => allChallengesInfo.set(doc.id, doc.data()));

            const attemptsSnapshot = await getDocs(query(collection(db, "attempts"), where("userId", "==", userId), orderBy("timestamp", "desc")));
            
            listEl.innerHTML = '';
            if (attemptsSnapshot.empty) {
                listEl.innerHTML = '<p class="text-gray-400">Nenhuma tentativa registrada.</p>';
                return;
            }

            attemptsSnapshot.forEach(doc => {
                const attempt = doc.data();
                const correctData = allChallengesInfo.get(attempt.challengeId);
                const statusClass = attempt.isCorrect ? 'border-green-500' : 'border-red-500';
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-gray-900/50 p-4 rounded-lg';
                wrapper.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4">
                        <img src="https://lh3.googleusercontent.com/d/${attempt.challengeId}" class="w-full md:w-48 h-auto rounded-md object-cover border-2 border-gray-600">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-white">${attempt.challengeName}</h3>
                            <div class="text-sm mt-1">
                                <p class="text-gray-300 font-semibold">Resposta Correta:</p>
                                <p class="text-white">Massa: ${correctData?.mass}g, Vol: ${correctData?.volume}cm³, Mat: ${correctData?.material}</p>
                            </div>
                            <hr class="border-gray-600 my-2">
                            <div class="bg-gray-700 p-2 rounded border-l-4 ${statusClass} text-xs">
                                <p class="text-white"><b>Resposta do Usuário:</b> Massa: ${attempt.userAnswer.mass}, Vol: ${attempt.userAnswer.volume}</p>
                                <p class="text-gray-500 text-right">${new Date(attempt.timestamp?.toDate()).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>`;
                listEl.appendChild(wrapper);
            });
        }

        async function loadUserPurchases(userId) {
            const listEl = document.getElementById('tab-content-purchases');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const purchasesSnapshot = await getDocs(query(collection(db, "users", userId, "purchases"), orderBy("purchaseDate", "desc")));
            listEl.innerHTML = '';
            if (purchasesSnapshot.empty) {
                listEl.innerHTML = '<p class="text-gray-400">Nenhum item comprado.</p>';
            } else {
                purchasesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <p class="text-white font-semibold">${data.itemName}</p>
                            <p class="text-xs text-gray-400">${new Date(data.purchaseDate?.toDate()).toLocaleString()}</p>
                        </div>
                        <span class="text-yellow-400 font-semibold">${data.price} pts</span>
                    `;
                    listEl.appendChild(div);
                });
            }
        }
    </script>
</body>
</html>

