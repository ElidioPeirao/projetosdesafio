<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio de Projetos Mecânicos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos Customizados -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1b2a; /* Tom de azul escuro */
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(rgba(255, 255, 255, 0.04) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.04) 2px, transparent 2px);
            background-size: 20px 20px, 20px 20px, 100px 100px, 100px 100px;
            background-position: -1px -1px, -1px -1px, -1px -1px, -1px -1px;
        }
        ::placeholder { color: #9ca3af; opacity: 1; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%239ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            padding-right: 2.5rem;
        }
        .loader {
            border: 4px solid #f3f3f340; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .zoomable { cursor: zoom-in; }
    </style>
</head>
<body>

    <!-- Container de Autenticação (Visível por padrão) -->
    <div id="auth-container" class="relative min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 space-y-6 border border-white/20">
            <div class="flex justify-center">
                <img src="https://i.imgur.com/VLCCzbc.png" alt="Logo" class="w-32 h-auto" onerror="this.onerror=null; this.src='https://placehold.co/128x50/000000/FFFFFF?text=Logo';">
            </div>
            <div class="flex border-b border-gray-500">
                <button id="tab-login" class="flex-1 py-2 text-center font-semibold text-white border-b-2 border-indigo-500 transition-colors duration-300">Login</button>
                <button id="tab-register" class="flex-1 py-2 text-center font-semibold text-gray-400 border-b-2 border-transparent transition-colors duration-300">Cadastro</button>
            </div>
            <div id="message-box" class="hidden p-3 rounded-lg text-center text-sm font-medium"></div>
            <!-- Formulário de Login -->
            <div id="form-login">
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="text-sm font-medium text-gray-300">Email</label>
                        <input type="email" id="login-email" required class="mt-1 w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="seuemail@exemplo.com">
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label for="login-password" class="text-sm font-medium text-gray-300">Senha</label>
                            <a href="#" id="forgot-password" class="text-xs font-medium text-indigo-400 hover:underline">Esqueceu a senha?</a>
                        </div>
                        <div class="relative">
                            <input type="password" id="login-password" required class="mt-1 w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="********">
                            <button type="button" class="password-toggle absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500">Entrar</button>
                </form>
            </div>
            <!-- Formulário de Cadastro -->
            <div id="form-register" class="hidden">
                 <form id="register-form" class="space-y-4">
                    <input type="text" id="register-name" required class="w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Nome Completo">
                    <input type="email" id="register-email" required class="w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Email">
                    <div class="relative">
                        <input type="password" id="register-password" required class="w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Senha">
                         <button type="button" class="password-toggle absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <div class="relative">
                        <input type="password" id="register-confirm-password" required class="w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Confirmar Senha">
                         <button type="button" class="password-toggle absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500">Cadastrar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Container do Jogo (Oculto por padrão) -->
    <div id="game-container" class="hidden">
        <div class="relative min-h-screen flex items-center justify-center p-4">
             <div class="w-full max-w-4xl bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 space-y-6 border border-white/20">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-2xl font-bold text-white">Desafio de Projetos</h1>
                        <p id="user-email" class="text-sm text-gray-300"></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <span class="text-yellow-400 font-bold text-lg" id="user-score">0</span>
                            <span class="text-gray-400 text-sm">pontos</span>
                        </div>
                        <button id="shop-button" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700">Loja</button>
                        <button id="purchases-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Minhas Compras</button>
                        <button id="completed-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Completos</button>
                        <button id="logout-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Sair</button>
                    </div>
                </div>
                
                <!-- Seleção de Categoria -->
                <div id="start-challenge-container" class="space-y-4 text-center py-8">
                    <div class="flex flex-col sm:flex-row items-center gap-4 max-w-lg mx-auto">
                        <select id="category-select" class="w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                            <option value="" class="bg-gray-800">Selecione uma categoria...</option>
                        </select>
                        <button id="start-button" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                            <span id="button-text">Iniciar</span>
                        </button>
                    </div>
                     <p id="start-message" class="text-gray-400 mt-4 text-sm"></p>
                </div>

                <!-- Área do Desafio -->
                <div id="challenge-container" class="hidden space-y-4">
                    <div id="challenge-display" class="w-full min-h-[300px] bg-black/20 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center p-4">
                        <div id="loader" class="loader hidden"></div>
                        <p id="placeholder-text" class="text-gray-400 text-center"></p>
                        <img id="challenge-image" src="" alt="Desenho do desafio" class="hidden max-w-full max-h-[400px] rounded-md object-contain zoomable">
                    </div>
                    
                    <div class="bg-black/20 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Material Fornecido:</p>
                        <p id="material-info" class="font-bold text-white text-lg"></p>
                    </div>

                    <!-- Formulário de Resposta -->
                    <form id="answer-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-1"><label for="mass-input" class="text-sm font-medium text-gray-300">Massa (g)</label><input type="number" step="any" id="mass-input" required class="mt-1 w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg" placeholder="Ex: 15700"></div>
                        <div class="md:col-span-1"><label for="volume-input" class="text-sm font-medium text-gray-300">Volume (cm³)</label><input type="number" step="any" id="volume-input" required class="mt-1 w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg" placeholder="Ex: 1987"></div>
                        <div class="md:col-span-1"><button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Verificar</button></div>
                    </form>
                    <div id="answer-feedback" class="hidden p-3 rounded-lg text-center text-sm font-medium"></div>
                    <button id="next-challenge-button" class="hidden w-full sm:w-auto bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 mx-auto">Próximo Desafio</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>


    <script type="module">
        // --- SDKs DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, serverTimestamp, runTransaction, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // --- CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAbUkp2kVA4GXD2qZz_zOQRyR7skqQUwFg",
          authDomain: "projects-debbb.firebaseapp.com",
          projectId: "projects-debbb",
          storageBucket: "projects-debbb.appspot.com",
          messagingSenderId: "1016788358282",
          appId: "1:1016788358282:web:491d260dfac9bc19f88973",
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- VARIÁVEIS GLOBAIS ---
        let currentUser = null;
        let currentChallenge = null;
        let allChallenges = [];
        let completedChallenges = new Map();
        let userScore = 0;

        // --- ELEMENTOS DO DOM ---
        const authContainer = document.getElementById('auth-container');
        const gameContainer = document.getElementById('game-container');
        const messageBox = document.getElementById('message-box');
        const userScoreEl = document.getElementById('user-score');
        const modalContainer = document.getElementById('modal-container');
        
        // --- CONTROLE DE AUTENTICAÇÃO E VISIBILIDADE ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                await loadGameData(user);
                authContainer.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                document.getElementById('user-email').textContent = `Logado como: ${user.email}`;
            } else {
                authContainer.classList.remove('hidden');
                gameContainer.classList.add('hidden');
                allChallenges = [];
                completedChallenges.clear();
                userScore = 0;
            }
        });

        async function loadGameData(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                userScore = userDocSnap.data().score || 0;
                userScoreEl.textContent = userScore;
            }

            const challengesSnapshot = await getDocs(collection(db, "challenges"));
            allChallenges = challengesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const completedRef = collection(db, "users", user.uid, "completedChallenges");
            const completedSnapshot = await getDocs(completedRef);
            completedChallenges.clear();
            completedSnapshot.forEach((doc) => {
                completedChallenges.set(doc.id, doc.data());
            });
            
            populateCategories();

            if (userDocSnap.exists() && userDocSnap.data().activeChallenge) {
                const activeChallengeId = userDocSnap.data().activeChallenge;
                const challenge = allChallenges.find(c => c.id === activeChallengeId);
                if (challenge) {
                    currentChallenge = challenge;
                    displayChallenge(challenge);
                }
            }
        }

        function populateCategories() {
            const categorySelect = document.getElementById('category-select');
            const categories = [...new Set(allChallenges.map(c => c.category))];
            categorySelect.innerHTML = '<option value="" class="bg-gray-800">Selecione uma categoria...</option>';
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                option.className = 'bg-gray-800';
                categorySelect.appendChild(option);
            });
        }

        // --- LÓGICA DE AUTENTICAÇÃO ---
        document.getElementById('tab-login').addEventListener('click', (e) => switchTab(e.target));
        document.getElementById('tab-register').addEventListener('click', (e) => switchTab(e.target));
        function switchTab(clickedTab) {
            const isLogin = clickedTab.id === 'tab-login';
            document.getElementById('form-login').classList.toggle('hidden', !isLogin);
            document.getElementById('form-register').classList.toggle('hidden', isLogin);
        }
        document.querySelectorAll('.password-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const input = button.previousElementSibling;
                input.type = input.type === 'password' ? 'text' : 'password';
            });
        });
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = `p-3 rounded-lg text-center text-sm font-medium ${isError ? 'bg-red-500/50 text-red-100' : 'bg-green-500/50 text-green-100'}`;
        }
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            if (password !== document.getElementById('register-confirm-password').value) return showMessage('As senhas não coincidem.', true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), { name, email, activeChallenge: null, score: 0 });
                showMessage('Cadastro realizado! Faça o login.');
                switchTab(document.getElementById('tab-login'));
            } catch (error) { showMessage('Erro: ' + error.code, true); }
        });
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
            } catch (error) { showMessage('Email ou senha inválidos.', true); }
        });
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

        // --- LÓGICA DO JOGO ---
        const startButton = document.getElementById('start-button');
        const categorySelect = document.getElementById('category-select');
        const challengeContainer = document.getElementById('challenge-container');
        const challengeImage = document.getElementById('challenge-image');
        const materialInfo = document.getElementById('material-info');
        const answerForm = document.getElementById('answer-form');
        const answerFeedback = document.getElementById('answer-feedback');
        const nextChallengeButton = document.getElementById('next-challenge-button');

        categorySelect.addEventListener('change', () => {
            startButton.disabled = !categorySelect.value;
        });

        function displayChallenge(challenge) {
            const startContainer = document.getElementById('start-challenge-container');
            const loader = document.getElementById('loader');
            const placeholderText = document.getElementById('placeholder-text');

            startContainer.classList.add('hidden');
            challengeContainer.classList.remove('hidden');
            
            loader.classList.remove('hidden');
            placeholderText.classList.add('hidden');
            challengeImage.classList.add('hidden');

            materialInfo.textContent = challenge.material;
            challengeImage.src = `https://lh3.googleusercontent.com/d/${challenge.id}`;
            challengeImage.onload = () => {
                loader.classList.add('hidden');
                challengeImage.classList.remove('hidden');
            };
            challengeImage.onerror = () => {
                loader.classList.add('hidden');
                placeholderText.textContent = 'Erro ao carregar a imagem do desafio.';
                placeholderText.classList.remove('hidden');
            }
        }

        startButton.addEventListener('click', async () => {
            const selectedCategory = categorySelect.value;
            const challengesInCategory = allChallenges.filter(c => c.category === selectedCategory);
            const availableChallenges = challengesInCategory.filter(challenge => !completedChallenges.has(challenge.id));

            if (availableChallenges.length === 0) {
                document.getElementById('start-message').textContent = 'Parabéns! Você completou todos os desafios desta categoria.';
                return;
            }
            
            currentChallenge = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
            
            const userDocRef = doc(db, "users", currentUser.uid);
            await setDoc(userDocRef, { activeChallenge: currentChallenge.id }, { merge: true });

            displayChallenge(currentChallenge);
        });

        answerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || !currentChallenge) return;

            const userMass = parseFloat(document.getElementById('mass-input').value);
            const userVolume = parseFloat(document.getElementById('volume-input').value);
            
            const correctData = currentChallenge;
            const correctMass = parseFloat(correctData.mass);
            const correctVolume = parseFloat(correctData.volume);
            const tolerance = parseFloat(correctData.tolerance || 5);

            const isMassCorrect = Math.abs(userMass - correctMass) <= correctMass * (tolerance / 100);
            const isVolumeCorrect = Math.abs(userVolume - correctVolume) <= correctVolume * (tolerance / 100);
            const isCorrect = isMassCorrect && isVolumeCorrect;

            answerFeedback.textContent = isCorrect ? `Resposta Correta! +${correctData.score} pontos` : "Resposta Incorreta.";
            answerFeedback.className = `p-3 rounded-lg text-center text-sm font-medium ${isCorrect ? 'bg-green-500/50 text-green-100' : 'bg-red-500/50 text-red-100'}`;
            
            if(isCorrect) {
                answerForm.classList.add('hidden');
                nextChallengeButton.classList.remove('hidden');
                
                const userDocRef = doc(db, "users", currentUser.uid);
                const challengeScore = parseInt(currentChallenge.score || 0);
                
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userDocRef);
                    const newScore = (userDoc.data().score || 0) + challengeScore;
                    transaction.update(userDocRef, { score: newScore, activeChallenge: null });
                    
                    const completedDocRef = doc(db, "users", currentUser.uid, "completedChallenges", currentChallenge.id);
                    const userFinalAnswer = { mass: userMass, volume: userVolume };
                    transaction.set(completedDocRef, { challengeName: currentChallenge.name, completedAt: serverTimestamp(), userAnswer: userFinalAnswer });
                });

                userScore += challengeScore;
                userScoreEl.textContent = userScore;
                completedChallenges.set(currentChallenge.id, { challengeName: currentChallenge.name, userAnswer: { mass: userMass, volume: userVolume } });
            }

            await setDoc(doc(collection(db, "attempts")), {
                userId: currentUser.uid, userEmail: currentUser.email,
                challengeId: currentChallenge.id, challengeName: currentChallenge.name,
                userAnswer: { mass: userMass, volume: userVolume }, isCorrect, timestamp: serverTimestamp()
            });
        });
        
        nextChallengeButton.addEventListener('click', () => {
            challengeContainer.classList.add('hidden');
            document.getElementById('start-challenge-container').classList.remove('hidden');
            answerForm.classList.remove('hidden');
            nextChallengeButton.classList.add('hidden');
            answerFeedback.className = 'hidden';
            answerForm.reset();
            currentChallenge = null;
        });

        // --- LÓGICA DA LOJA ---
        document.getElementById('shop-button').addEventListener('click', async () => {
            createModal('shop-modal', `Sua Pontuação: ${userScore}`, `
                <div id="shop-items-list" class="max-h-[60vh] overflow-y-auto space-y-2 pr-2">Carregando itens...</div>
            `, 'max-w-2xl');
            openModal('shop-modal');

            const itemsSnapshot = await getDocs(collection(db, "shopItems"));
            const purchasesSnapshot = await getDocs(collection(db, "users", currentUser.uid, "purchases"));
            const purchasedItems = new Set(purchasesSnapshot.docs.map(d => d.id));

            const listEl = document.getElementById('shop-items-list');
            listEl.innerHTML = '';
            itemsSnapshot.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                const hasBought = item.type === 'unico' && purchasedItems.has(item.id);
                const canAfford = userScore >= item.price;
                const buttonDisabled = hasBought || !canAfford;

                let buttonHtml = `<button data-id="${item.id}" data-price="${item.price}" data-type="${item.type}" data-name="${item.name}" class="buy-item-btn bg-green-600 text-white px-4 py-2 text-sm rounded hover:bg-green-700 disabled:bg-gray-500" ${buttonDisabled ? 'disabled' : ''}>Comprar</button>`;
                if (hasBought) {
                    buttonHtml = `<span class="text-green-400 font-semibold">Adquirido</span>`;
                }

                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <p class="text-white font-semibold">${item.name}</p>
                        <p class="text-xs text-gray-400">${item.type === 'unico' ? 'Item único' : 'Pode ser comprado várias vezes'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-yellow-400 font-bold">${item.price} pts</p>
                        ${buttonHtml}
                    </div>`;
                listEl.appendChild(div);
            });
            listEl.querySelectorAll('.buy-item-btn').forEach(btn => btn.addEventListener('click', buyItem));
        });

        async function buyItem(e) {
            const { id, price, type, name } = e.target.dataset;
            const itemPrice = parseInt(price);

            if (confirm(`Comprar "${name}" por ${itemPrice} pontos?`)) {
                const userDocRef = doc(db, "users", currentUser.uid);
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const userDoc = await transaction.get(userDocRef);
                        const currentScore = userDoc.data().score || 0;

                        if (currentScore < itemPrice) throw "Pontos insuficientes!";

                        if (type === 'unico') {
                            const purchaseRef = doc(db, "users", currentUser.uid, "purchases", id);
                            const purchaseDoc = await transaction.get(purchaseRef);
                            if (purchaseDoc.exists()) throw "Você já possui este item!";
                            transaction.set(purchaseRef, { itemName: name, price: itemPrice, purchaseDate: serverTimestamp() });
                        } else {
                            const purchaseRef = doc(collection(db, "users", currentUser.uid, "purchases"));
                            transaction.set(purchaseRef, { itemId: id, itemName: name, price: itemPrice, purchaseDate: serverTimestamp() });
                        }
                        
                        transaction.update(userDocRef, { score: currentScore - itemPrice });
                    });

                    userScore -= itemPrice;
                    userScoreEl.textContent = userScore;
                    alert("Compra realizada com sucesso!");
                    closeModal('shop-modal');
                } catch (error) {
                    alert("Erro na compra: " + error);
                }
            }
        }
        
        // --- HISTÓRICO DE COMPRAS ---
        document.getElementById('purchases-button').addEventListener('click', async () => {
            createModal('purchases-modal', 'Histórico de Compras', '<div id="purchases-list" class="max-h-[60vh] overflow-y-auto space-y-2 pr-2">Carregando...</div>', 'max-w-2xl');
            openModal('purchases-modal');

            const listEl = document.getElementById('purchases-list');
            const purchasesSnapshot = await getDocs(query(collection(db, "users", currentUser.uid, "purchases"), orderBy("purchaseDate", "desc")));
            
            if (purchasesSnapshot.empty) {
                listEl.innerHTML = '<p class="text-gray-400">Você ainda não comprou nenhum item.</p>';
            } else {
                listEl.innerHTML = '';
                purchasesSnapshot.forEach(doc => {
                    const item = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <p class="text-white font-semibold">${item.itemName}</p>
                            <p class="text-xs text-gray-400">${new Date(item.purchaseDate?.toDate()).toLocaleString()}</p>
                        </div>
                        <span class="text-yellow-400 font-bold">${item.price} pts</span>`;
                    listEl.appendChild(div);
                });
            }
        });
        
        // --- FUNÇÕES DE MODAL GENÉRICAS ---
        function createModal(id, title, content, maxWidth = 'max-w-4xl') {
            const modalHtml = `
                <div id="${id}" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
                    <div class="modal-content w-full ${maxWidth} bg-gray-800 border border-gray-600 rounded-2xl shadow-xl p-6 transform scale-95">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">${title}</h2>
                            <button id="close-${id}" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div id="${id}-content" class="max-h-[75vh] overflow-auto">${content}</div>
                    </div>
                </div>`;
            modalContainer.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById(`close-${id}`).addEventListener('click', () => closeModal(id));
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            setTimeout(() => modal.querySelector('.modal-content').classList.remove('scale-95'), 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.querySelector('.modal-content').classList.add('scale-95');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // --- MODAIS DE COMPLETOS E ZOOM ---
        document.getElementById('completed-button').addEventListener('click', () => {
            let content = '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 pr-2">';
            if (completedChallenges.size === 0) {
                content += '<p class="text-gray-400 col-span-full">Você ainda não completou nenhum desafio.</p>';
            } else {
                completedChallenges.forEach((data, id) => {
                    content += `
                        <div class="aspect-square bg-gray-700 rounded-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform" onclick="window.showDetailsModal('${id}')">
                            <img src="https://lh3.googleusercontent.com/d/${id}" class="w-full h-full object-cover">
                        </div>`;
                });
            }
            content += '</div>';
            createModal('completed-modal', 'Desafios Completos', content);
            openModal('completed-modal');
        });
        
        challengeImage.addEventListener('click', () => {
             if(currentChallenge) showImageZoomModal(currentChallenge);
        });

        window.showDetailsModal = (id) => {
            const data = completedChallenges.get(id);
            let content = '';
            if (data && data.userAnswer) {
                content = `
                    <img src="https://lh3.googleusercontent.com/d/${id}" class="w-full h-auto rounded-md mb-4">
                    <p><span class="font-semibold text-gray-400">Sua Resposta de Massa:</span> ${data.userAnswer.mass} g</p>
                    <p><span class="font-semibold text-gray-400">Sua Resposta de Volume:</span> ${data.userAnswer.volume} cm³</p>
                `;
            } else {
                content = '<p class="text-gray-400">Dados da sua resposta não encontrados.</p>';
            }
            createModal('details-modal', data.challengeName || "Detalhes", content, 'max-w-lg');
            openModal('details-modal');
        }

        function showImageZoomModal(challenge) {
            createModal('zoom-modal', challenge.name, `<img src="https://lh3.googleusercontent.com/d/${challenge.id}" class="w-full h-auto rounded-md">`);
            openModal('zoom-modal');
        }

    </script>
</body>
</html>
