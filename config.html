<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administrador</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos Customizados -->
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #2563eb; /* Tom de azul blueprint */
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.07) 1px, transparent 1px),
                linear-gradient(rgba(255, 255, 255, 0.05) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 2px, transparent 2px);
            background-size: 20px 20px, 20px 20px, 100px 100px, 100px 100px;
            background-position: -1px -1px, -1px -1px, -1px -1px, -1px -1px;
        }
        ::placeholder { color: #9ca3af; opacity: 1; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        * { scrollbar-width: thin; scrollbar-color: #4a5568 rgba(0, 0, 0, 0.2); }
    </style>
</head>
<body>

    <!-- Container de Login -->
    <div id="admin-login-container" class="relative min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 space-y-6 border border-white/20">
            <h1 class="text-2xl font-bold text-white text-center">Acesso Restrito</h1>
            <p class="text-center text-gray-300 text-sm">Painel para Administradores e Moderadores.</p>
            <div id="admin-message-box" class="hidden p-3 rounded-lg text-center text-sm font-medium"></div>
            <form id="admin-login-form" class="space-y-6">
                <div>
                    <label for="admin-user" class="text-sm font-medium text-gray-300">E-mail</label>
                    <input type="email" id="admin-user" required class="mt-1 w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg" placeholder="Digite seu e-mail">
                </div>
                <div>
                    <label for="admin-password" class="text-sm font-medium text-gray-300">Senha</label>
                    <input type="password" id="admin-password" required class="mt-1 w-full p-3 bg-white/20 text-white border border-gray-600 rounded-lg" placeholder="Digite sua senha">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Container do Painel Principal -->
    <div id="admin-panel-container" class="hidden relative p-4 md:p-8">
        <div class="w-full max-w-7xl mx-auto bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-8 space-y-8 border border-white/20">
            <!-- Cabeçalho -->
            <div class="flex justify-between items-center">
                <div>
                    <h1 id="main-title" class="text-3xl font-bold text-white cursor-pointer hover:text-gray-300">Painel Administrativo</h1>
                    <p id="admin-user-email" class="text-sm text-gray-300"></p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <button id="notifications-btn" class="text-white hover:text-gray-300 relative">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span id="notifications-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden">0</span>
                        </button>
                        <div id="notifications-list" class="absolute right-0 mt-8 w-80 bg-gray-800 border border-gray-600 rounded-lg shadow-lg z-10 hidden max-h-96 overflow-y-auto">
                            <!-- As notificações serão preenchidas aqui -->
                        </div>
                    </div>
                    <button id="admin-logout-button" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Sair</button>
                </div>
            </div>
            
            <!-- Dashboard View -->
            <div id="dashboard-view" class="space-y-8">
                <!-- Métricas Principais -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-black/20 p-6 rounded-lg text-white"><p class="text-sm text-gray-300">Total de Usuários</p><h3 id="total-users-metric" class="text-3xl font-bold">...</h3></div>
                    <div class="bg-black/20 p-6 rounded-lg text-white"><p class="text-sm text-gray-300">Novos Usuários (24h)</p><h3 id="new-users-metric" class="text-3xl font-bold">...</h3></div>
                    <div class="bg-black/20 p-6 rounded-lg text-white"><p class="text-sm text-gray-300">Desafios Ativos</p><h3 id="total-challenges-metric" class="text-3xl font-bold">...</h3></div>
                </div>
                <!-- Atividades e Ranking -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold text-white mb-4">Atividades Recentes</h3>
                        <div id="recent-activities-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-white mb-4">Ranking de Jogadores (Top 5)</h3>
                        <div id="user-ranking-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Menu Principal -->
            <div id="main-menu" class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                <button id="manage-challenges-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-6 rounded-lg text-lg transition">Desafios</button>
                <button id="manage-levels-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-6 rounded-lg text-lg transition">Níveis</button>
                <button id="manage-achievements-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-6 rounded-lg text-lg transition">Conquistas</button>
                <button id="manage-shop-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-6 rounded-lg text-lg transition">Loja</button>
                <button id="manage-themes-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-6 rounded-lg text-lg transition">Temas</button>
                <button id="manage-codes-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-6 rounded-lg text-lg transition">Códigos</button>
                <button id="view-users-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 rounded-lg text-lg transition">Usuários</button>
                <button id="manage-settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-6 rounded-lg text-lg transition">Configurações</button>
            </div>

            <!-- Conteúdo Dinâmico -->
            <div id="dynamic-content" class="hidden bg-black/20 p-6 rounded-lg"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>


    <script type="module">
        // --- SDKs DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, query, orderBy, onSnapshot, where, updateDoc, serverTimestamp, addDoc, Timestamp, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyAbUkp2kVA4GXD2qZz_zOQRyR7skqQUwFg",
          authDomain: "projects-debbb.firebaseapp.com",
          projectId: "projects-debbb",
          storageBucket: "projects-debbb.appspot.com",
          messagingSenderId: "1016788358282",
          appId: "1:1016788358282:web:491d260dfac9bc19f88973",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- VARIÁVEIS GLOBAIS ---
        let currentUser = { auth: null, data: null, role: null };
        let allChallengesData = [];
        let allAchievementsData = [];
        let allLevelsData = [];
        let allUsersData = [];
        let unreadNotifications = [];

        // --- ELEMENTOS DO DOM ---
        const loginContainer = document.getElementById('admin-login-container');
        const panelContainer = document.getElementById('admin-panel-container');
        const messageBox = document.getElementById('admin-message-box');
        const dynamicContent = document.getElementById('dynamic-content');
        const dashboardView = document.getElementById('dashboard-view');
        const mainMenu = document.getElementById('main-menu');
        const modalContainer = document.getElementById('modal-container');
        const notificationsBtn = document.getElementById('notifications-btn');
        const notificationsCount = document.getElementById('notifications-count');
        const notificationsList = document.getElementById('notifications-list');

        // --- LOGIN E AUTENTICAÇÃO ---
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-user').value.trim();
            const password = document.getElementById('admin-password').value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                // O onAuthStateChanged vai lidar com a exibição do painel
            } catch (error) {
                showAdminMessage('E-mail ou senha inválidos.', true);
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && (userDocSnap.data().role === 'admin' || userDocSnap.data().role === 'moderator')) {
                    currentUser.auth = user;
                    currentUser.data = userDocSnap.data();
                    currentUser.role = userDocSnap.data().role;

                    loginContainer.classList.add('hidden');
                    panelContainer.classList.remove('hidden');
                    document.getElementById('admin-user-email').textContent = `Usuário: ${currentUser.data.email} (${currentUser.role})`;
                    
                    updateUIVisibility();
                    listenForNotifications();
                    showDashboard();
                    await Promise.all([fetchAllChallenges(), loadAllAchievements(), fetchAllLevels()]);
                } else {
                    showAdminMessage('Acesso negado. Você não tem permissão para entrar.', true);
                    signOut(auth);
                }
            } else {
                currentUser = { auth: null, data: null, role: null };
                panelContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                dynamicContent.classList.add('hidden');
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-user').value = '';
            }
        });

        document.getElementById('admin-logout-button').addEventListener('click', () => {
            signOut(auth);
        });
        
        function showAdminMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.className = `p-3 rounded-lg text-center text-sm font-medium ${isError ? 'bg-red-500/50 text-red-100' : 'bg-green-500/50 text-green-100'}`;
        }

        function updateUIVisibility() {
            const isAdmin = currentUser.role === 'admin';
            const isModerator = currentUser.role === 'moderator';
            
            // Define a visibilidade dos botões
            document.getElementById('manage-shop-btn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('manage-themes-btn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('manage-codes-btn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('view-users-btn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('manage-settings-btn').style.display = isAdmin ? 'block' : 'none';
            
            // Adiciona o novo botão de aprovações para o admin
            const existingApprovalBtn = document.getElementById('pending-changes-btn');
            if (isAdmin && !existingApprovalBtn) {
                const approvalBtn = document.createElement('button');
                approvalBtn.id = 'pending-changes-btn';
                approvalBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-6 rounded-lg text-lg transition';
                approvalBtn.textContent = 'Aprovações';
                approvalBtn.addEventListener('click', () => showSection(showPendingChangesManagement));
                mainMenu.appendChild(approvalBtn);
            } else if (!isAdmin && existingApprovalBtn) {
                existingApprovalBtn.remove();
            }

            // Adiciona botão de "Em Aprovação" para moderadores
            const existingInApprovalBtn = document.getElementById('in-approval-btn');
            if (isModerator && !existingInApprovalBtn) {
                const inApprovalBtn = document.createElement('button');
                inApprovalBtn.id = 'in-approval-btn';
                inApprovalBtn.className = 'bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-6 rounded-lg text-lg transition relative';
                inApprovalBtn.textContent = 'Em Aprovação';
                inApprovalBtn.addEventListener('click', () => showSection(showInApprovalManagement));
                mainMenu.appendChild(inApprovalBtn);
            } else if (!isModerator && existingInApprovalBtn) {
                existingInApprovalBtn.remove();
            }

            // Adiciona botão de revisão para moderador
            const existingReviewBtn = document.getElementById('review-needed-btn');
            if (isModerator && !existingReviewBtn) {
                const reviewBtn = document.createElement('button');
                reviewBtn.id = 'review-needed-btn';
                reviewBtn.className = 'bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-6 rounded-lg text-lg transition relative';
                reviewBtn.textContent = 'Revisões';
                reviewBtn.addEventListener('click', () => showSection(showReviewNeededManagement));
                mainMenu.appendChild(reviewBtn);
            } else if (!isModerator && existingReviewBtn) {
                existingReviewBtn.remove();
            }

            // Adjust grid columns based on role
            if (isAdmin) {
                mainMenu.classList.remove('md:grid-cols-5');
                mainMenu.classList.add('md:grid-cols-4');
            } else if (isModerator) {
                mainMenu.classList.remove('md:grid-cols-4');
                mainMenu.classList.add('md:grid-cols-5');
            }
        }
        
        // --- DASHBOARD ---
        async function showDashboard() {
            dashboardView.classList.remove('hidden');
            mainMenu.classList.remove('hidden');
            dynamicContent.classList.add('hidden');
            await loadDashboardData();
        }

        async function loadDashboardData() {
            // Métricas
            const usersSnapshot = await getDocs(collection(db, "users"));
            const challengesSnapshot = await getDocs(collection(db, "challenges"));
            document.getElementById('total-users-metric').textContent = usersSnapshot.size;
            document.getElementById('total-challenges-metric').textContent = challengesSnapshot.size;
            document.getElementById('new-users-metric').textContent = 'N/A'; // Requer campo 'createdAt' nos usuários
            
            // Atividades Recentes
            const activitiesList = document.getElementById('recent-activities-list');
            activitiesList.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const attemptsQuery = query(collection(db, "attempts"), orderBy("timestamp", "desc"), limit(5));
            const attemptsSnapshot = await getDocs(attemptsQuery);
            activitiesList.innerHTML = '';
            if (attemptsSnapshot.empty) {
                activitiesList.innerHTML = '<p class="text-gray-400">Nenhuma atividade recente.</p>';
            } else {
                attemptsSnapshot.forEach(doc => {
                    const attempt = doc.data();
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-lg text-sm flex justify-between items-center ${attempt.isCorrect ? 'bg-green-800/40' : 'bg-red-800/40'}`;
                    div.innerHTML = `<div><p class="font-semibold text-white">${attempt.userEmail}</p><p class="text-gray-300">Tentou: ${attempt.challengeName}</p></div><p class="text-xs text-gray-400">${new Date(attempt.timestamp?.toDate()).toLocaleDateString()}</p>`;
                    activitiesList.appendChild(div);
                });
            }

            // Ranking de Usuários
            const rankingList = document.getElementById('user-ranking-list');
            rankingList.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const usersQuery = query(collection(db, "users"), orderBy("xp", "desc"), limit(5));
            const topUsersSnapshot = await getDocs(usersQuery);
            rankingList.innerHTML = '';
            if (topUsersSnapshot.empty) {
                rankingList.innerHTML = '<p class="text-gray-400">Nenhum usuário no ranking.</p>';
            } else {
                let rank = 1;
                topUsersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700/50 p-3 rounded-lg flex items-center justify-between';
                    div.innerHTML = `<div class="flex items-center gap-3"><span class="font-bold text-lg text-indigo-400 w-6 text-center">${rank}</span><div><p class="font-semibold text-white">${user.email}</p><p class="text-xs text-yellow-400">${user.score || 0} pts</p></div></div><p class="text-cyan-400 font-semibold">${user.xp || 0} XP</p>`;
                    rankingList.appendChild(div);
                    rank++;
                });
            }
        }
        
        // --- SISTEMA DE NOTIFICAÇÕES ---
        function listenForNotifications() {
            const q = query(collection(db, "purchaseNotifications"), where("read", "==", false));
            onSnapshot(q, (snapshot) => {
                unreadNotifications = snapshot.docs;
                const count = unreadNotifications.length;
                notificationsCount.textContent = count;
                notificationsCount.classList.toggle('hidden', count === 0);
            });
        }
        
        notificationsBtn.addEventListener('click', async () => {
            notificationsList.classList.toggle('hidden');
            if (!notificationsList.classList.contains('hidden')) {
                const q = query(collection(db, "purchaseNotifications"), orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);
                notificationsList.innerHTML = snapshot.empty ? '<p class="text-gray-400 p-4 text-center text-sm">Nenhuma notificação.</p>' : '';
                snapshot.forEach(doc => {
                    const notif = doc.data();
                    const div = document.createElement('div');
                    div.className = `p-3 border-b border-gray-700 ${!notif.read ? 'bg-indigo-900/50' : ''}`;
                    div.innerHTML = `<p class="text-sm text-white"><span class="font-bold">${notif.userEmail}</span> comprou <span class="font-bold">${notif.itemName}</span>.</p><p class="text-xs text-gray-400 mt-1">${new Date(notif.timestamp?.toDate()).toLocaleString()}</p>`;
                    notificationsList.appendChild(div);
                });
                unreadNotifications.forEach(doc => updateDoc(doc.ref, { read: true }));
            }
        });

        // --- NAVEGAÇÃO DO PAINEL ---
        document.getElementById('main-title').addEventListener('click', showDashboard);

        function showSection(sectionFunction) {
            dashboardView.classList.add('hidden');
            mainMenu.classList.add('hidden');
            sectionFunction();
        }

        document.getElementById('manage-challenges-btn').addEventListener('click', () => showSection(showChallengesManagement));
        document.getElementById('manage-shop-btn').addEventListener('click', () => showSection(showShopManagement));
        document.getElementById('manage-levels-btn').addEventListener('click', () => showSection(showLevelsManagement));
        document.getElementById('manage-achievements-btn').addEventListener('click', () => showSection(showAchievementsManagement));
        document.getElementById('manage-themes-btn').addEventListener('click', () => showSection(showThemesManagement));
        document.getElementById('manage-codes-btn').addEventListener('click', () => showSection(showCodesManagement));
        document.getElementById('view-users-btn').addEventListener('click', () => showSection(showUsersManagement));
        document.getElementById('manage-settings-btn').addEventListener('click', () => showSection(showSettingsManagement));

        // --- FUNÇÕES DE MODAL GENÉRICAS ---
        function createModal(id, title, content, maxWidth = 'max-w-xl') {
            document.getElementById(id)?.remove();
            const modalHtml = `
                <div id="${id}" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300">
                    <div class="modal-content w-full ${maxWidth} bg-gray-800 border border-gray-600 rounded-2xl shadow-xl p-6 transform scale-95 transition-transform duration-300">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">${title}</h2>
                            <button onclick="document.getElementById('${id}').remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div class="max-h-[70vh] overflow-y-auto pr-2">${content}</div>
                    </div>
                </div>`;
            modalContainer.insertAdjacentHTML('beforeend', modalHtml);
            const modal = document.getElementById(id);
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }
        
        // --- GERENCIAMENTO DE DESAFIOS ---
        async function showChallengesManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `<div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><h2 class="text-2xl font-semibold text-white">Desafios Cadastrados</h2><div class="flex items-center gap-2 flex-wrap justify-end"><input type="text" id="filter-name" placeholder="Filtrar por nome..." class="bg-gray-700 text-white p-2 rounded-lg border border-gray-600 text-sm"><select id="filter-category" class="bg-gray-700 text-white p-2 rounded-lg border border-gray-600 text-sm"><option value="">Todas as Categorias</option></select><button id="add-new-challenge-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 whitespace-nowrap text-sm">Adicionar/Propor Novo</button></div></div><div id="challenges-list" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>`;
            document.getElementById('add-new-challenge-btn').addEventListener('click', () => openChallengeModal());
            document.getElementById('filter-name').addEventListener('input', renderChallengesList);
            document.getElementById('filter-category').addEventListener('change', renderChallengesList);
            await fetchAllChallenges();
            renderChallengesList();
        }

        async function fetchAllChallenges() {
            const querySnapshot = await getDocs(collection(db, "challenges"));
            allChallengesData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function renderChallengesList() {
            const listEl = document.getElementById('challenges-list'); if (!listEl) return;
            const categories = [...new Set(allChallengesData.map(c => c.category))];
            const categoryFilter = document.getElementById('filter-category');
            const currentCategorySelection = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">Todas as Categorias</option>';
            categories.sort().forEach(cat => categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`);
            categoryFilter.value = currentCategorySelection;
            const filtered = allChallengesData.filter(c => c.name.toLowerCase().includes(document.getElementById('filter-name').value.toLowerCase()) && (!categoryFilter.value || c.category === categoryFilter.value));
            listEl.innerHTML = filtered.length === 0 ? '<p class="text-gray-400">Nenhum desafio encontrado.</p>' : '';
            filtered.forEach(data => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                let timeInfo = '';
                const timeLimitInSeconds = parseInt(data.timeLimit) || 0;
                if (timeLimitInSeconds > 0) {
                    const minutes = Math.floor(timeLimitInSeconds / 60);
                    const seconds = timeLimitInSeconds % 60;
                    let timeString = `${minutes}min`;
                    if (seconds > 0) timeString += ` ${seconds}s`;
                    timeInfo = `<span class="text-xs bg-cyan-500 text-white px-2 py-1 rounded-full ml-2 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg> ${timeString} (x${data.bonusMultiplier})</span>`;
                }
                div.innerHTML = `<div class="flex items-center gap-2 flex-wrap"><div class="cursor-pointer" data-id="${data.id}" data-name="${data.name}"><span class="text-white font-semibold">${data.name}</span></div><span class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-full">${data.category}</span><span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full">${data.score} pts</span>${timeInfo}</div><div><button data-id="${data.id}" class="edit-challenge-btn bg-blue-600 text-white px-2 py-1 text-xs rounded hover:bg-blue-700 mr-2">Editar/Propor</button><button data-id="${data.id}" class="delete-challenge-btn bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Excluir</button></div>`;
                listEl.appendChild(div);
            });
            listEl.querySelectorAll('.delete-challenge-btn').forEach(btn => btn.addEventListener('click', deleteChallenge));
            listEl.querySelectorAll('.edit-challenge-btn').forEach(btn => btn.addEventListener('click', e => openChallengeModal(e.target.dataset.id)));
            listEl.querySelectorAll('.cursor-pointer').forEach(el => el.addEventListener('click', e => showChallengeImage(e.currentTarget.dataset.id, e.currentTarget.dataset.name)));
        }
        
        async function deleteChallenge(e) {
            const id = e.target.dataset.id;
            if (currentUser.role !== 'admin') {
                createModal('error-modal', 'Acesso Negado', '<p class="text-gray-300">Apenas administradores podem excluir desafios.</p>', 'max-w-sm');
                return;
            }
            createModal('confirm-delete-modal', 'Confirmar Exclusão', `<p class="text-gray-300 mb-6">Tem certeza que deseja excluir este desafio?</p><div class="flex justify-end gap-4"><button onclick="document.getElementById('confirm-delete-modal').remove()" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Cancelar</button><button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Excluir</button></div>`, 'max-w-md');
            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                await deleteDoc(doc(db, "challenges", id));
                await fetchAllChallenges();
                renderChallengesList();
                document.getElementById('confirm-delete-modal').remove();
            });
        }

        function showChallengeImage(id, name) {
            createModal('challenge-image-modal', name, `<img src="https://lh3.googleusercontent.com/d/${id}" class="w-full h-auto rounded-md">`, 'max-w-2xl');
        }

        async function openChallengeModal(challengeId = null, pendingChange = null, pendingChangeId = null) {
            const categories = [...new Set(allChallengesData.map(d => d.category).filter(Boolean))];
            const datalistHtml = categories.map(c => `<option value="${c}"></option>`).join('');
            createModal('challenge-modal', 'Gerenciar Desafio', `
                <form id="add-challenge-form" class="space-y-4">
                    <input type="hidden" id="challenge-id-hidden">
                    <input type="hidden" id="pending-change-id-hidden">
                    <div>
                        <label for="challenge-url" class="block text-sm font-medium text-gray-300 mb-1">URL do Desafio (Google Drive)</label>
                        <input type="text" id="challenge-url" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Link completo do Arquivo...">
                        <div id="image-preview-container" class="mt-2 hidden">
                            <p class="text-xs text-gray-400 mb-1">Pré-visualização:</p>
                            <img id="challenge-image-preview" src="" alt="Pré-visualização do Desafio" class="rounded-lg max-h-48 w-auto mx-auto bg-gray-900/50 p-1">
                        </div>
                    </div>
                    <div>
                        <label for="challenge-name" class="block text-sm font-medium text-gray-300 mb-1">Nome do Desafio</label>
                        <input type="text" id="challenge-name" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Ex: Peça 135">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="challenge-category" class="block text-sm font-medium text-gray-300 mb-1">Categoria</label>
                            <input type="text" id="challenge-category" list="categories-datalist" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Categoria da peça">
                        </div>
                        <div>
                            <label for="challenge-score" class="block text-sm font-medium text-gray-300 mb-1">Pontuação</label>
                            <input type="number" step="1" id="challenge-score" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Ex: 10" value="10">
                        </div>
                        <div>
                            <label for="challenge-tolerance" class="block text-sm font-medium text-gray-300 mb-1">Tolerância (%)</label>
                            <input type="number" step="any" id="challenge-tolerance" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Ex: 5" value="5">
                        </div>
                    </div>
                    <datalist id="categories-datalist">${datalistHtml}</datalist>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="challenge-mass" class="block text-sm font-medium text-gray-300 mb-1">Massa (g)</label>
                            <input type="number" step="any" id="challenge-mass" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Gramas">
                        </div>
                        <div>
                            <label for="challenge-volume" class="block text-sm font-medium text-gray-300 mb-1">Volume (cm³)</label>
                            <input type="number" step="any" id="challenge-volume" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Centímetros cúbicos">
                        </div>
                        <div>
                            <label for="challenge-material" class="block text-sm font-medium text-gray-300 mb-1">Material</label>
                            <input type="text" id="challenge-material" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Ex: Aço, Plástico...">
                        </div>
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="challenge-timeLimit" class="block text-sm font-medium text-gray-300 mb-1">Tempo Limite (minutos)</label>
                            <input type="number" step="any" id="challenge-timeLimit" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Opcional">
                        </div>
                        <div>
                            <label for="challenge-bonusMultiplier" class="block text-sm font-medium text-gray-300 mb-1">Multiplicador de Bônus</label>
                            <input type="number" step="0.1" id="challenge-bonusMultiplier" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Ex: 1.5">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Salvar Desafio</button>
                </form>
            `, 'max-w-xl');

            const urlInput = document.getElementById('challenge-url');
            const previewContainer = document.getElementById('image-preview-container');
            const previewImg = document.getElementById('challenge-image-preview');

            function updateChallengeImagePreview() {
                const url = urlInput.value;
                const fileId = url.match(/\/d\/(.*?)(?:\/|$)/)?.[1];
                if (fileId) {
                    previewImg.src = `https://lh3.googleusercontent.com/d/${fileId}`;
                    previewContainer.classList.remove('hidden');
                } else {
                    previewContainer.classList.add('hidden');
                }
            }
            urlInput.addEventListener('input', updateChallengeImagePreview);

            if (pendingChange) {
                const data = pendingChange.data;
                document.getElementById('pending-change-id-hidden').value = pendingChangeId;
                document.getElementById('challenge-id-hidden').value = pendingChange.targetId;
                document.getElementById('challenge-url').value = `https://drive.google.com/file/d/${pendingChange.targetId}/view`;
                if (data.timeLimit) document.getElementById('challenge-timeLimit').value = data.timeLimit / 60;
                ['name', 'category', 'score', 'tolerance', 'mass', 'volume', 'material', 'bonusMultiplier'].forEach(key => {
                    const el = document.getElementById(`challenge-${key}`);
                    if (el && data[key] !== undefined) el.value = data[key];
                });
            } else if (challengeId) {
                const docSnap = await getDoc(doc(db, "challenges", challengeId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('challenge-id-hidden').value = challengeId;
                    document.getElementById('challenge-url').value = `https://drive.google.com/file/d/${challengeId}/view`;
                    if(data.timeLimit) document.getElementById('challenge-timeLimit').value = data.timeLimit / 60;
                    ['name', 'category', 'score', 'tolerance', 'mass', 'volume', 'material', 'bonusMultiplier'].forEach(key => {
                        const el = document.getElementById(`challenge-${key}`);
                        if (el && data[key] !== undefined) el.value = data[key];
                    });
                }
            }
            updateChallengeImagePreview(); // Call once to show existing image
            document.getElementById('add-challenge-form').addEventListener('submit', saveChallenge);
        }

        async function saveChallenge(e) {
            e.preventDefault();
            const pendingChangeId = document.getElementById('pending-change-id-hidden').value;
            const url = document.getElementById('challenge-url').value;
            let originalId = document.getElementById('challenge-id-hidden').value;
            let newId = originalId || url.match(/\/d\/(.*?)(?:\/|$)/)?.[1];
            if (!newId) {
                createModal('error-modal', 'URL Inválida', '<p class="text-gray-300">A URL do Google Drive parece ser inválida. Verifique o link.</p>', 'max-w-sm');
                return;
            }
            
            const timeInMinutes = parseFloat(document.getElementById('challenge-timeLimit').value) || 0;
            const data = {
                name: document.getElementById('challenge-name').value,
                category: document.getElementById('challenge-category').value,
                mass: document.getElementById('challenge-mass').value,
                volume: document.getElementById('challenge-volume').value,
                material: document.getElementById('challenge-material').value,
                tolerance: document.getElementById('challenge-tolerance').value,
                score: document.getElementById('challenge-score').value,
                timeLimit: timeInMinutes * 60,
                bonusMultiplier: document.getElementById('challenge-bonusMultiplier').value || 1.5,
            };
            
            document.getElementById('challenge-modal').remove();

            if (pendingChangeId) {
                const changeDocRef = doc(db, "pendingChanges", pendingChangeId);
                const changeDocSnap = await getDoc(changeDocRef);
                const wasInReview = changeDocSnap.exists() && changeDocSnap.data().status === 'review_needed';

                await updateDoc(changeDocRef, { 
                    data: data, 
                    status: 'pending', 
                    reviewNotes: null, 
                    reviewedBy: null,
                    timestamp: serverTimestamp() 
                });

                if (wasInReview) {
                    createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta reenviada para aprovação.</p>', 'max-w-sm');
                    showReviewNeededManagement();
                } else {
                    createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta de alteração foi atualizada e aguarda aprovação.</p>', 'max-w-sm');
                    showInApprovalManagement();
                }
            } else if (currentUser.role === 'admin') {
                await setDoc(doc(db, "challenges", newId), data);
                createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Desafio salvo com sucesso.</p>', 'max-w-sm');
                await fetchAllChallenges();
                renderChallengesList();
            } else { // Moderador
                await addDoc(collection(db, "pendingChanges"), {
                    type: 'challenge',
                    action: originalId ? 'update' : 'create',
                    targetId: newId,
                    data: data,
                    proposedBy: currentUser.data.email,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });
                createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta de desafio enviada para aprovação.</p>', 'max-w-sm');
            }
        }

        // --- GERENCIAMENTO DA LOJA (SOMENTE ADMIN) ---
        async function showShopManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-white">Itens da Loja</h2><button id="add-new-item-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Adicionar Novo Item</button></div><div id="shop-items-list" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>`;
            document.getElementById('add-new-item-btn').addEventListener('click', () => openShopItemModal());
            await loadShopItems();
        }

        async function loadShopItems() {
            const listEl = document.getElementById('shop-items-list');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const querySnapshot = await getDocs(collection(db, "shopItems"));
            listEl.innerHTML = '';
            if (querySnapshot.empty) {
                listEl.innerHTML = '<p class="text-gray-400">Nenhum item na loja.</p>';
            } else {
                const itemTypes = { unico: 'Único', multiplo: 'Múltiplo', consumable_reroll: 'Consumível (Troca)', consumable_choice: 'Consumível (Escolha)', consumable_abandon: 'Consumível (Abandonar)' };
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    div.innerHTML = `<div><span class="text-white font-semibold">${data.name}</span><span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full ml-2">${data.price} pts</span><span class="text-xs bg-purple-500 text-white px-2 py-1 rounded-full ml-2">${itemTypes[data.type] || 'Desconhecido'}</span></div><div><button data-id="${doc.id}" class="edit-item-btn bg-blue-600 text-white px-2 py-1 text-xs rounded hover:bg-blue-700 mr-2">Editar</button><button data-id="${doc.id}" class="delete-item-btn bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Excluir</button></div>`;
                    listEl.appendChild(div);
                });
            }
            document.querySelectorAll('.delete-item-btn').forEach(btn => btn.addEventListener('click', (e) => deleteDoc(doc(db, "shopItems", e.target.dataset.id)).then(loadShopItems)));
            document.querySelectorAll('.edit-item-btn').forEach(btn => btn.addEventListener('click', (e) => openShopItemModal(e.target.dataset.id)));
        }

        async function openShopItemModal(itemId = null) {
            createModal('shop-item-modal', 'Gerenciar Item da Loja', `
                <form id="add-item-form" class="space-y-4">
                    <input type="hidden" id="item-id-hidden"><input type="text" id="item-name" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Nome do Item"><div class="grid grid-cols-2 gap-4"><input type="number" id="item-price" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Preço (pontos)"><select id="item-type" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg"><option value="unico">Compra Única</option><option value="multiplo">Compra Múltipla</option><option value="consumable_reroll">Consumível (Trocar Desafio)</option><option value="consumable_choice">Consumível (Escolher Desafio)</option><option value="consumable_abandon">Consumível (Abandonar Desafio)</option></select></div><button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Salvar Item</button>
                </form>
            `);
            if (itemId) {
                const docSnap = await getDoc(doc(db, "shopItems", itemId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('item-id-hidden').value = itemId;
                    document.getElementById('item-name').value = data.name;
                    document.getElementById('item-price').value = data.price;
                    document.getElementById('item-type').value = data.type;
                }
            }
            document.getElementById('add-item-form').addEventListener('submit', saveShopItem);
        }

        async function saveShopItem(e) {
            e.preventDefault();
            let id = document.getElementById('item-id-hidden').value;
            const type = document.getElementById('item-type').value;
            if (type.startsWith('consumable')) id = type.split('_')[1] + '_token';
            else if (!id) id = Date.now().toString();
            const data = { name: document.getElementById('item-name').value, price: parseInt(document.getElementById('item-price').value), type: type };
            await setDoc(doc(db, "shopItems", id), data);
            document.getElementById('shop-item-modal').remove();
            await loadShopItems();
        }
        
        // --- GERENCIAMENTO DE NÍVEIS ---
        async function showLevelsManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-white">Níveis de Experiência</h2><button id="add-new-level-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Adicionar/Propor Nível</button></div><div id="levels-list" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>`;
            document.getElementById('add-new-level-btn').addEventListener('click', () => openLevelModal());
            await loadLevels();
        }

        async function fetchAllLevels() {
            const q = query(collection(db, "levels"), orderBy("xpRequired", "asc"));
            const querySnapshot = await getDocs(q);
            allLevelsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        
        async function loadLevels() {
            const listEl = document.getElementById('levels-list');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            await fetchAllLevels();
            listEl.innerHTML = allLevelsData.length === 0 ? '<p class="text-gray-400">Nenhum nível cadastrado. Crie o primeiro nível com 0 XP.</p>' : '';
            allLevelsData.forEach(data => {
                const docId = data.id;
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                const rewardPoints = data.reward?.points > 0 ? `<span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full ml-2">${data.reward.points} pts</span>` : '';
                const rewardReroll = data.reward?.reroll > 0 ? `<span class="text-xs bg-orange-500 text-white px-2 py-1 rounded-full ml-2">x${data.reward.reroll} Troca</span>` : '';
                const rewardChoice = data.reward?.choice > 0 ? `<span class="text-xs bg-teal-500 text-white px-2 py-1 rounded-full ml-2">x${data.reward.choice} Escolha</span>` : '';
                const rewardAbandon = data.reward?.abandon > 0 ? `<span class="text-xs bg-gray-500 text-white px-2 py-1 rounded-full ml-2">x${data.reward.abandon} Aband.</span>` : '';

                div.innerHTML = `
                    <div class="flex items-center gap-4 flex-wrap">
                        <span class="w-6 h-6 rounded border border-gray-500" style="background-color: ${data.color || '#FFFFFF'};"></span>
                        <div>
                           <span class="text-white font-semibold">${data.name}</span>
                           <span class="text-xs bg-cyan-500 text-white px-2 py-1 rounded-full ml-2">XP Mínimo: ${data.xpRequired}</span>
                        </div>
                        ${rewardPoints}${rewardReroll}${rewardChoice}${rewardAbandon}
                    </div>
                    <div>
                        <button data-id="${docId}" class="edit-level-btn bg-blue-600 text-white px-2 py-1 text-xs rounded hover:bg-blue-700 mr-2">Editar/Propor</button>
                        <button data-id="${docId}" class="delete-level-btn bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Excluir</button>
                    </div>
                `;
                listEl.appendChild(div);
            });
            document.querySelectorAll('.delete-level-btn').forEach(btn => btn.addEventListener('click', (e) => {
                 if (currentUser.role !== 'admin') {
                    createModal('error-modal', 'Acesso Negado', '<p class="text-gray-300">Apenas administradores podem excluir níveis.</p>', 'max-w-sm');
                    return;
                }
                deleteDoc(doc(db, "levels", e.target.dataset.id)).then(loadLevels)
            }));
            document.querySelectorAll('.edit-level-btn').forEach(btn => btn.addEventListener('click', (e) => openLevelModal(e.target.dataset.id)));
        }

        async function openLevelModal(levelId = null, pendingChange = null, pendingChangeId = null) {
            createModal('level-modal', 'Gerenciar Nível', `
                <form id="add-level-form" class="space-y-4">
                    <input type="hidden" id="level-id-hidden">
                    <input type="hidden" id="pending-change-id-hidden">
                    <input type="text" id="level-name" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Nome do Nível (ex: Aprendiz)">
                    <input type="number" id="level-xp" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="XP necessário para alcançar">
                    <div class="flex items-center gap-2">
                        <label for="level-color" class="text-gray-300">Cor do Nível:</label>
                        <input type="color" id="level-color" required class="w-16 h-10 p-1 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer" value="#FFFFFF">
                    </div>
                    <div class="border-t border-gray-600 pt-4">
                        <label class="text-sm font-medium text-gray-300">Recompensas por Atingir o Nível (Opcional)</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                            <input type="number" id="reward-points" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Pontos">
                            <input type="number" id="reward-reroll" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Tokens Troca">
                            <input type="number" id="reward-choice" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Tokens Escolha">
                            <input type="number" id="reward-abandon" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Tokens Aband.">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Salvar Nível</button>
                </form>
            `);
            
            if(pendingChange) {
                const data = pendingChange.data;
                document.getElementById('pending-change-id-hidden').value = pendingChangeId;
                document.getElementById('level-id-hidden').value = pendingChange.targetId;
                document.getElementById('level-name').value = data.name;
                document.getElementById('level-xp').value = data.xpRequired;
                document.getElementById('level-color').value = data.color || '#FFFFFF';
                if (data.reward) {
                    document.getElementById('reward-points').value = data.reward.points || '';
                    document.getElementById('reward-reroll').value = data.reward.reroll || '';
                    document.getElementById('reward-choice').value = data.reward.choice || '';
                    document.getElementById('reward-abandon').value = data.reward.abandon || '';
                }
            } else if (levelId) {
                const data = allLevelsData.find(l => l.id === levelId);
                if (data) {
                    document.getElementById('level-id-hidden').value = levelId;
                    document.getElementById('level-name').value = data.name;
                    document.getElementById('level-xp').value = data.xpRequired;
                    document.getElementById('level-color').value = data.color || '#FFFFFF';
                    if (data.reward) {
                        document.getElementById('reward-points').value = data.reward.points || '';
                        document.getElementById('reward-reroll').value = data.reward.reroll || '';
                        document.getElementById('reward-choice').value = data.reward.choice || '';
                        document.getElementById('reward-abandon').value = data.reward.abandon || '';
                    }
                }
            }

            document.getElementById('add-level-form').addEventListener('submit', saveLevel);
        }

        async function saveLevel(e) {
            e.preventDefault();
            const pendingChangeId = document.getElementById('pending-change-id-hidden').value;
            const levelId = document.getElementById('level-id-hidden').value;
            const data = { 
                name: document.getElementById('level-name').value, 
                xpRequired: parseInt(document.getElementById('level-xp').value),
                color: document.getElementById('level-color').value,
                reward: {
                    points: parseInt(document.getElementById('reward-points').value) || 0,
                    reroll: parseInt(document.getElementById('reward-reroll').value) || 0,
                    choice: parseInt(document.getElementById('reward-choice').value) || 0,
                    abandon: parseInt(document.getElementById('reward-abandon').value) || 0,
                }
            };
            
            document.getElementById('level-modal').remove();

            if (pendingChangeId) {
                const changeDocRef = doc(db, "pendingChanges", pendingChangeId);
                const changeDocSnap = await getDoc(changeDocRef);
                const wasInReview = changeDocSnap.exists() && changeDocSnap.data().status === 'review_needed';
                await updateDoc(changeDocRef, { 
                    data: data, 
                    status: 'pending', 
                    reviewNotes: null, 
                    reviewedBy: null,
                    timestamp: serverTimestamp() 
                });
                
                if (wasInReview) {
                    createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta reenviada para aprovação.</p>', 'max-w-sm');
                    showReviewNeededManagement();
                } else {
                    createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta de alteração foi atualizada e aguarda aprovação.</p>', 'max-w-sm');
                    showInApprovalManagement();
                }
            } else if (currentUser.role === 'admin') {
                const targetId = levelId || doc(collection(db, "levels")).id;
                await setDoc(doc(db, "levels", targetId), data);
                createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Nível salvo com sucesso.</p>', 'max-w-sm');
                await loadLevels();
            } else { // Moderador
                const targetId = levelId || doc(collection(db, "levels")).id;
                await addDoc(collection(db, "pendingChanges"), {
                    type: 'level',
                    action: levelId ? 'update' : 'create',
                    targetId: targetId,
                    data: data,
                    proposedBy: currentUser.data.email,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });
                createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta de nível enviada para aprovação.</p>', 'max-w-sm');
            }
        }

        // --- GERENCIAMENTO DE CONQUISTAS ---
        async function showAchievementsManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-white">Conquistas</h2><button id="add-new-achievement-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Adicionar/Propor Conquista</button></div><div id="achievements-list" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>`;
            document.getElementById('add-new-achievement-btn').addEventListener('click', () => openAchievementModal());
            await loadAchievements();
        }

        async function loadAllAchievements() {
            const q = query(collection(db, "achievements"), orderBy("name", "asc"));
            const querySnapshot = await getDocs(q);
            allAchievementsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadAchievements() {
            const listEl = document.getElementById('achievements-list');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            if (allAchievementsData.length === 0) {
                await loadAllAchievements();
            }
            if (allAchievementsData.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">Nenhuma conquista cadastrada.</p>';
            } else {
                listEl.innerHTML = '';
                allAchievementsData.forEach(data => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                    div.innerHTML = `<div class="flex items-center gap-3"><img src="${data.iconUrl}" class="w-10 h-10 rounded"><div><p class="text-white font-semibold">${data.name}</p><p class="text-xs text-gray-400">${data.description}</p></div></div><div class="text-right"><button data-id="${data.id}" class="edit-achievement-btn bg-blue-600 text-white px-2 py-1 text-xs rounded hover:bg-blue-700 mr-2">Editar/Propor</button><button data-id="${data.id}" class="delete-achievement-btn bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Excluir</button></div>`;
                    listEl.appendChild(div);
                });
            }
            document.querySelectorAll('.delete-achievement-btn').forEach(btn => btn.addEventListener('click', (e) => {
                 if (currentUser.role !== 'admin') {
                    createModal('error-modal', 'Acesso Negado', '<p class="text-gray-300">Apenas administradores podem excluir conquistas.</p>', 'max-w-sm');
                    return;
                }
                deleteDoc(doc(db, "achievements", e.target.dataset.id)).then(loadAllAchievements).then(loadAchievements)
            }));
            document.querySelectorAll('.edit-achievement-btn').forEach(btn => btn.addEventListener('click', (e) => openAchievementModal(e.target.dataset.id)));
        }

        async function openAchievementModal(achievementId = null, pendingChange = null, pendingChangeId = null) {
            const categories = [...new Set(allChallengesData.map(d => d.category).filter(Boolean))];
            const categoryOptions = categories.map(c => `<option value="${c}">${c}</option>`).join('');

            createModal('achievement-modal', 'Gerenciar Conquista', `
                <form id="add-achievement-form" class="space-y-4">
                    <input type="hidden" id="achievement-id-hidden">
                    <input type="hidden" id="pending-change-id-hidden">
                    <input type="text" id="achievement-name" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Nome da Conquista">
                    <input type="text" id="achievement-desc" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Descrição">
                    <input type="url" id="achievement-icon" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="URL do Ícone (Imgur)">
                    <div class="border-t border-gray-600 pt-4">
                        <label class="text-sm font-medium text-gray-300">Condição para Desbloqueio</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                            <select id="achievement-condition-type" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg">
                                <option value="xp">XP Total Alcançado</option>
                                <option value="challenges_completed">Total de Desafios Completos</option>
                                <option value="category_completed">Desafios Completos em Categoria</option>
                                <option value="points_spent">Pontos Gastos na Loja</option>
                                <option value="exclusive">Exclusiva (Admin)</option>
                            </select>
                            <input type="number" id="achievement-condition-value" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Valor (ex: 1000)">
                        </div>
                        <select id="achievement-condition-category" class="hidden w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg mt-4">
                            <option value="">Selecione a categoria</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    <div class="border-t border-gray-600 pt-4">
                        <label class="text-sm font-medium text-gray-300">Recompensas (Opcional)</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                            <input type="text" id="achievement-reward-title" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Título Desbloqueado (ex: Cadista)">
                            <input type="url" id="achievement-reward-badge" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="URL da Insígnia (Imgur)">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Salvar Conquista</button>
                </form>
            `);

            const conditionTypeSelect = document.getElementById('achievement-condition-type');
            const conditionValueInput = document.getElementById('achievement-condition-value');
            const conditionCategorySelect = document.getElementById('achievement-condition-category');

            const toggleConditionInputs = () => {
                const type = conditionTypeSelect.value;
                conditionCategorySelect.classList.toggle('hidden', type !== 'category_completed');
                const isValueHidden = type === 'exclusive';
                conditionValueInput.classList.toggle('hidden', isValueHidden);
                conditionValueInput.required = !isValueHidden;
            };
            
            conditionTypeSelect.addEventListener('change', toggleConditionInputs);
            
            if (pendingChange) {
                const data = pendingChange.data;
                document.getElementById('pending-change-id-hidden').value = pendingChangeId;
                document.getElementById('achievement-id-hidden').value = pendingChange.targetId;
                document.getElementById('achievement-name').value = data.name || '';
                document.getElementById('achievement-desc').value = data.description || '';
                document.getElementById('achievement-icon').value = data.iconUrl || '';
                if (data.condition) {
                    conditionTypeSelect.value = data.condition.type;
                    conditionValueInput.value = data.condition.value;
                    if(data.condition.category) conditionCategorySelect.value = data.condition.category;
                }
                if (data.reward) {
                    document.getElementById('achievement-reward-title').value = data.reward.title || '';
                    document.getElementById('achievement-reward-badge').value = data.reward.badgeUrl || '';
                }
            } else if (achievementId) {
                const data = allAchievementsData.find(a => a.id === achievementId);
                if(data) {
                    document.getElementById('achievement-id-hidden').value = achievementId;
                    document.getElementById('achievement-name').value = data.name || '';
                    document.getElementById('achievement-desc').value = data.description || '';
                    document.getElementById('achievement-icon').value = data.iconUrl || '';
                    if (data.condition) {
                        conditionTypeSelect.value = data.condition.type;
                        conditionValueInput.value = data.condition.value;
                        if(data.condition.category) conditionCategorySelect.value = data.condition.category;
                    }
                    if (data.reward) {
                        document.getElementById('achievement-reward-title').value = data.reward.title || '';
                        document.getElementById('achievement-reward-badge').value = data.reward.badgeUrl || '';
                    }
                }
            }
            
            toggleConditionInputs();
            document.getElementById('add-achievement-form').addEventListener('submit', saveAchievement);
        }

        async function saveAchievement(e) {
            e.preventDefault();
            const pendingChangeId = document.getElementById('pending-change-id-hidden').value;
            const achievementId = document.getElementById('achievement-id-hidden').value;
            
            const conditionType = document.getElementById('achievement-condition-type').value;
            const condition = { type: conditionType, value: parseInt(document.getElementById('achievement-condition-value').value) || 0 };
            if (conditionType === 'category_completed') {
                condition.category = document.getElementById('achievement-condition-category').value;
                if (!condition.category) return alert('Por favor, selecione uma categoria para esta condição.');
            }
            const data = {
                name: document.getElementById('achievement-name').value,
                description: document.getElementById('achievement-desc').value,
                iconUrl: document.getElementById('achievement-icon').value,
                condition: condition,
                reward: { title: document.getElementById('achievement-reward-title').value || null, badgeUrl: document.getElementById('achievement-reward-badge').value || null }
            };

            document.getElementById('achievement-modal').remove();

            if (pendingChangeId) {
                const changeDocRef = doc(db, "pendingChanges", pendingChangeId);
                const changeDocSnap = await getDoc(changeDocRef);
                const wasInReview = changeDocSnap.exists() && changeDocSnap.data().status === 'review_needed';
                await updateDoc(changeDocRef, { 
                    data: data,
                    status: 'pending',
                    reviewNotes: null,
                    reviewedBy: null,
                    timestamp: serverTimestamp()
                });
                
                if (wasInReview) {
                    createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta reenviada para aprovação.</p>', 'max-w-sm');
                    showReviewNeededManagement();
                } else {
                    createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta de alteração foi atualizada e aguarda aprovação.</p>', 'max-w-sm');
                    showInApprovalManagement();
                }
            } else if (currentUser.role === 'admin') {
                const targetId = achievementId || doc(collection(db, "achievements")).id;
                await setDoc(doc(db, "achievements", targetId), data);
                createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Conquista salva com sucesso.</p>', 'max-w-sm');
                await loadAllAchievements();
                await loadAchievements();
            } else { // Moderador
                const targetId = achievementId || doc(collection(db, "achievements")).id;
                 await addDoc(collection(db, "pendingChanges"), {
                    type: 'achievement',
                    action: achievementId ? 'update' : 'create',
                    targetId: targetId,
                    data: data,
                    proposedBy: currentUser.data.email,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });
                createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta de conquista enviada para aprovação.</p>', 'max-w-sm');
            }
        }
        
        // --- GERENCIAMENTO DE USUÁRIOS (SOMENTE ADMIN) ---
        function renderUsersList(filter = '') {
            const usersList = document.getElementById('users-list');
            if (!usersList) return;

            const lowercasedFilter = filter.toLowerCase().trim();
            const filteredUsers = allUsersData.filter(user => 
                user.data.email.toLowerCase().includes(lowercasedFilter)
            );

            usersList.innerHTML = filteredUsers.length === 0 ? '<p class="text-gray-400">Nenhum usuário encontrado.</p>' : '';
            
            filteredUsers.forEach(user => {
                const userData = user.data;
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center cursor-pointer hover:bg-gray-600';
                div.innerHTML = `<div><span class="text-white">${userData.email}</span><span class="text-sm text-cyan-400 ml-4">${userData.xp || 0} XP</span></div><span class="text-yellow-400 font-semibold">${userData.score || 0} pts</span>`;
                div.addEventListener('click', () => showUserDetailsModal(user.id, userData.email));
                usersList.appendChild(div);
            });
        }

        async function showUsersManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                     <h2 class="text-2xl font-semibold text-white">Usuários Cadastrados</h2>
                     <input type="text" id="user-search-input" placeholder="Buscar por email..." class="bg-gray-700 text-white p-2 rounded-lg border border-gray-600 text-sm w-full sm:w-auto">
                </div>
                <div id="users-list" class="max-h-[30rem] overflow-y-auto space-y-2 pr-2"></div>`;
            
            document.getElementById('user-search-input').addEventListener('input', (e) => {
                renderUsersList(e.target.value);
            });

            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            
            const usersSnapshot = await getDocs(query(collection(db, "users"), orderBy("xp", "desc")));
            allUsersData = usersSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            
            renderUsersList(); 
        }

        async function showUserDetailsModal(userId, email) {
            createModal('user-details-modal', `Detalhes de ${email}`, `
                <div class="border-b border-gray-600 mb-4"><nav class="flex -mb-px"><button data-tab="actions" class="tab-btn border-b-2 border-indigo-500 text-white py-2 px-4">Ações</button><button data-tab="attempts" class="tab-btn border-b-2 border-transparent text-gray-400 py-2 px-4">Tentativas</button><button data-tab="purchases" class="tab-btn border-b-2 border-transparent text-gray-400 py-2 px-4">Itens Comprados</button><button data-tab="award" class="tab-btn border-b-2 border-transparent text-gray-400 py-2 px-4">Conceder Conquista</button></nav></div>
                <div id="tab-content-actions" class="tab-content max-h-[60vh] overflow-y-auto space-y-4 pr-2"></div>
                <div id="tab-content-attempts" class="tab-content hidden max-h-[60vh] overflow-y-auto space-y-4 pr-2"></div>
                <div id="tab-content-purchases" class="tab-content hidden max-h-[60vh] overflow-y-auto space-y-2 pr-2"></div>
                <div id="tab-content-award" class="tab-content hidden max-h-[60vh] overflow-y-auto space-y-2 pr-2"></div>
            `, 'max-w-4xl');
            
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => tab.addEventListener('click', e => {
                tabs.forEach(t => t.className = 'tab-btn border-b-2 border-transparent text-gray-400 py-2 px-4');
                e.target.className = 'tab-btn border-b-2 border-indigo-500 text-white py-2 px-4';
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-content-${e.target.dataset.tab}`).classList.remove('hidden');
            }));

            await loadUserAdminActions(userId, email);
            await loadUserAttempts(userId);
            await loadUserPurchases(userId);
            await loadUserAchievementsForAward(userId);
        }

        async function loadUserAdminActions(userId, email) {
            const tabContent = document.getElementById('tab-content-actions');
            if (!tabContent) return;

            const userDocRef = doc(db, "users", userId);
            const userDocSnap = await getDoc(userDocRef);
            if (!userDocSnap.exists()) {
                tabContent.innerHTML = '<p class="text-red-400">Usuário não encontrado.</p>';
                return;
            }
            const userData = userDocSnap.data();

            tabContent.innerHTML = `
                 <div>
                    <h4 class="text-lg font-semibold text-white mb-2">Gerenciar Cargo</h4>
                    <div class="flex items-center gap-4 p-4 bg-black/20 rounded-lg">
                        <select id="user-role-select" class="w-full p-2 bg-gray-900 text-white border border-gray-600 rounded-lg">
                            <option value="player" ${!userData.role || userData.role === 'player' ? 'selected' : ''}>Jogador</option>
                            <option value="moderator" ${userData.role === 'moderator' ? 'selected' : ''}>Moderador</option>
                            <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        <button id="save-role-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg whitespace-nowrap">Salvar Cargo</button>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-white mb-2 mt-4">Editar Pontos e XP</h4>
                    <form id="edit-user-stats-form" class="space-y-3 p-4 bg-black/20 rounded-lg">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="user-score" class="text-sm text-gray-300">Pontos (Score)</label>
                                <input type="number" id="user-score" class="mt-1 w-full p-2 bg-gray-900 text-white border border-gray-600 rounded-lg" value="${userData.score || 0}">
                            </div>
                            <div>
                                <label for="user-xp" class="text-sm text-gray-300">Experiência (XP)</label>
                                <input type="number" id="user-xp" class="mt-1 w-full p-2 bg-gray-900 text-white border border-gray-600 rounded-lg" value="${userData.xp || 0}">
                            </div>
                        </div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Alterações</button>
                    </form>
                </div>
                <div class="border-t border-red-500/30 pt-4 mt-4">
                    <h4 class="text-lg font-semibold text-red-400 mb-2">Zona de Perigo</h4>
                    <div class="space-y-3 p-4 bg-black/20 rounded-lg">
                        <p class="text-sm text-gray-400">As ações abaixo são irreversíveis e devem ser usadas com cuidado.</p>
                        <div class="flex flex-wrap gap-4">
                            <button id="reset-user-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Redefinir Progresso</button>
                            <button id="ban-user-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Banir Usuário</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('save-role-btn').addEventListener('click', async () => {
                const newRole = document.getElementById('user-role-select').value;
                createModal('confirm-role-change', 'Confirmar Alteração', `<p class="text-gray-300">Tem certeza que deseja alterar o cargo de ${email} para ${newRole}?</p><div class="flex justify-end gap-2 mt-4"><button onclick="document.getElementById('confirm-role-change').remove()">Cancelar</button><button id="confirm-role-btn" class="bg-indigo-500 text-white p-2 rounded">Confirmar</button></div>`, 'max-w-sm');
                document.getElementById('confirm-role-btn').onclick = async () => {
                     await updateDoc(userDocRef, { role: newRole });
                     document.getElementById('confirm-role-change').remove();
                     createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Cargo atualizado!</p>', 'max-w-sm');
                }
            });

            const banBtn = document.getElementById('ban-user-btn');
            if (userData.isBanned) {
                banBtn.textContent = 'Desbanir Usuário';
                banBtn.classList.replace('bg-red-600', 'bg-green-600');
                banBtn.classList.replace('hover:bg-red-700', 'hover:bg-green-700');
            }

            document.getElementById('edit-user-stats-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newScore = parseInt(document.getElementById('user-score').value);
                const newXp = parseInt(document.getElementById('user-xp').value);
                updateUserStats(userId, newScore, newXp, email);
            });
            document.getElementById('reset-user-btn').addEventListener('click', () => confirmUserReset(userId, email));
            banBtn.addEventListener('click', () => confirmUserBanToggle(userId, email, userData.isBanned || false));
        }

        // --- DEMAIS FUNÇÕES DE USUÁRIO (reset, ban, grant, etc.) ---
        async function updateUserStats(userId, newScore, newXp, email) {
            const userDocRef = doc(db, "users", userId);
            await updateDoc(userDocRef, { score: newScore, xp: newXp });
            createModal('success-modal', 'Sucesso', `<p class="text-gray-300">Pontos e XP de ${email} atualizados.</p>`, 'max-w-sm');
        }

        function confirmUserReset(userId, email) {
            createModal('confirm-user-reset-modal', 'Confirmar Redefinição', `
                <p class="text-gray-300 mb-4">Você tem certeza que deseja redefinir TODO o progresso de <span class="font-bold text-white">${email}</span>?</p>
                <p class="text-sm text-yellow-400 mb-6">Isso inclui XP, pontos, conquistas, tentativas e compras. A ação não pode ser desfeita.</p>
                <div class="flex justify-end gap-4">
                    <button onclick="document.getElementById('confirm-user-reset-modal').remove()" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Cancelar</button>
                    <button id="confirm-reset-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Redefinir</button>
                </div>
            `, 'max-w-md');

            document.getElementById('confirm-reset-btn').addEventListener('click', async () => {
                await resetUserProgress(userId, email);
                document.getElementById('confirm-user-reset-modal').remove();
            });
        }

        async function resetUserProgress(userId, email) {
            try {
                const userDocRef = doc(db, "users", userId);
                await updateDoc(userDocRef, { 
                    score: 0, 
                    xp: 0, 
                    isBanned: false,
                    reroll_token: 0,
                    choice_token: 0,
                    abandon_token: 0
                });

                const collectionsToDelete = ['unlockedAchievements', 'purchasedItems'];
                for (const coll of collectionsToDelete) {
                    const snapshot = await getDocs(collection(db, "users", userId, coll));
                    await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref)));
                }

                const rootCollectionsToClean = ['attempts', 'purchaseNotifications'];
                for (const coll of rootCollectionsToClean) {
                    const q = query(collection(db, coll), where("userId", "==", userId));
                    const snapshot = await getDocs(q);
                    await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref)));
                }

                createModal('success-modal', 'Sucesso', `<p class="text-gray-300">O progresso de ${email} foi redefinido.</p>`, 'max-w-sm');
                if (document.getElementById('user-details-modal')) {
                    loadUserAdminActions(userId, email);
                }
            } catch (error) {
                console.error("Erro ao redefinir usuário: ", error);
                createModal('error-modal', 'Erro', `<p class="text-gray-300">Ocorreu um erro. Verifique o console.</p>`, 'max-w-sm');
            }
        }

        function confirmUserBanToggle(userId, email, isCurrentlyBanned) {
            const actionText = isCurrentlyBanned ? 'Desbanir' : 'Banir';
            createModal('confirm-user-ban-modal', `Confirmar ${actionText}`, `
                <p class="text-gray-300 mb-6">Você tem certeza que deseja <span class="font-bold text-white">${actionText.toLowerCase()}</span> o usuário <span class="font-bold text-white">${email}</span>?</p>
                <div class="flex justify-end gap-4">
                    <button onclick="document.getElementById('confirm-user-ban-modal').remove()" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Cancelar</button>
                    <button id="confirm-ban-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">${actionText}</button>
                </div>
            `, 'max-w-md');

            document.getElementById('confirm-ban-btn').addEventListener('click', async () => {
                await toggleUserBan(userId, email, isCurrentlyBanned);
                document.getElementById('confirm-user-ban-modal').remove();
            });
        }

        async function toggleUserBan(userId, email, isCurrentlyBanned) {
            const userDocRef = doc(db, "users", userId);
            await updateDoc(userDocRef, { isBanned: !isCurrentlyBanned });
            const actionText = isCurrentlyBanned ? 'desbanido' : 'banido';
            createModal('success-modal', 'Sucesso', `<p class="text-gray-300">Usuário ${email} foi ${actionText}.</p>`, 'max-w-sm');
            if (document.getElementById('user-details-modal')) {
                loadUserAdminActions(userId, email);
            }
        }
        
        async function loadUserAchievementsForAward(userId) {
            const listEl = document.getElementById('tab-content-award');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const unlockedSnapshot = await getDocs(collection(db, "users", userId, "unlockedAchievements"));
            const unlockedIds = new Set(unlockedSnapshot.docs.map(d => d.id));
            listEl.innerHTML = '';
            if (allAchievementsData.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">Nenhuma conquista cadastrada.</p>'; return;
            }
            allAchievementsData.forEach(achieve => {
                const hasAchieved = unlockedIds.has(achieve.id);
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                div.innerHTML = `<div class="flex items-center gap-3"><img src="${achieve.iconUrl}" class="w-10 h-10 rounded"><div><p class="text-white font-semibold">${achieve.name}</p><p class="text-xs text-gray-400">${achieve.description}</p></div></div><button data-id="${achieve.id}" data-user-id="${userId}" class="grant-achievement-btn bg-green-600 text-white px-2 py-1 text-xs rounded hover:bg-green-700 disabled:bg-gray-500" ${hasAchieved ? 'disabled' : ''}>${hasAchieved ? 'Concedida' : 'Conceder'}</button>`;
                listEl.appendChild(div);
            });
            document.querySelectorAll('.grant-achievement-btn').forEach(btn => btn.addEventListener('click', grantAchievement));
        }

        function grantAchievement(e) {
            const button = e.target;
            const achievementId = button.dataset.id;
            const userId = button.dataset.userId;
            
            createModal('confirm-grant-modal', 'Confirmar Concessão', `
                <p class="text-gray-300 mb-6">Conceder esta conquista para o usuário?</p>
                <div class="flex justify-end gap-4">
                    <button onclick="document.getElementById('confirm-grant-modal').remove()" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Cancelar</button>
                    <button id="confirm-grant-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button>
                </div>
            `, 'max-w-md');

            document.getElementById('confirm-grant-btn').addEventListener('click', async () => {
                await setDoc(doc(db, "users", userId, "unlockedAchievements", achievementId), { unlockedAt: serverTimestamp(), grantedByAdmin: true });
                button.disabled = true;
                button.textContent = 'Concedida';
                document.getElementById('confirm-grant-modal').remove();
            });
        }
        
        async function loadUserAttempts(userId) {
            const listEl = document.getElementById('tab-content-attempts');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const q = query(collection(db, "attempts"), where("userId", "==", userId));
            const snapshot = await getDocs(q);

            const attempts = snapshot.docs.map(doc => doc.data());
            attempts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

            listEl.innerHTML = attempts.length === 0 ? '<p class="text-gray-400">Nenhuma tentativa registrada.</p>' : '';
            
            attempts.forEach(attempt => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-lg ${attempt.isCorrect ? 'bg-green-800/50' : 'bg-red-800/50'}`;
                div.innerHTML = `
                    <p class="font-bold text-white">${attempt.challengeName}</p>
                    <p class="text-sm text-gray-300">Massa: ${attempt.userAnswer.mass}g | Volume: ${attempt.userAnswer.volume}cm³</p>
                    <p class="text-xs text-gray-400 mt-1">${new Date(attempt.timestamp?.toDate()).toLocaleString()}</p>
                `;
                listEl.appendChild(div);
            });
        }

        async function loadUserPurchases(userId) {
            const listEl = document.getElementById('tab-content-purchases');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const q = query(collection(db, "purchaseNotifications"), where("userId", "==", userId));
            const snapshot = await getDocs(q);

            const purchases = snapshot.docs.map(doc => doc.data());
            purchases.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

            listEl.innerHTML = purchases.length === 0 ? '<p class="text-gray-400">Nenhum item comprado.</p>' : '';
            
            purchases.forEach(purchase => {
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <p class="text-white font-semibold">${purchase.itemName}</p>
                         <p class="text-xs text-gray-400">${new Date(purchase.timestamp?.toDate()).toLocaleString()}</p>
                    </div>
                    <p class="text-yellow-400 font-bold">${purchase.price} pts</p>
                `;
                listEl.appendChild(div);
            });
        }

        // --- GERENCIAMENTO DE APROVAÇÕES E REVISÕES ---
        async function showInApprovalManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `<h2 class="text-2xl font-semibold text-white mb-4">Itens Aguardando Aprovação</h2><div id="in-approval-list" class="max-h-[70vh] overflow-y-auto space-y-4 pr-2"></div>`;
            
            const listEl = document.getElementById('in-approval-list');
            listEl.innerHTML = '<p class="text-gray-400">A carregar...</p>';
            
            const q = query(collection(db, "pendingChanges"), where("status", "==", "pending"));
            const snapshot = await getDocs(q);
            
            const pendingDocs = snapshot.docs;
            pendingDocs.sort((a, b) => (b.data().timestamp?.toDate() || 0) - (a.data().timestamp?.toDate() || 0));

            if (pendingDocs.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">Não há itens aguardando aprovação no momento.</p>';
                return;
            }

            listEl.innerHTML = '';
            
            pendingDocs.forEach(docChange => {
                const change = docChange.data();
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3';
                
                const actionText = change.action === 'create' ? 'criação' : 'atualização';
                const typeText = { challenge: 'Desafio', level: 'Nível', achievement: 'Conquista'}[change.type] || 'Item';
                let description = `Proposta de ${actionText} de ${typeText}: <strong class="text-indigo-300">${change.data.name}</strong><br><em class="text-xs text-gray-400">Por: ${change.proposedBy}</em>`;
                
                div.innerHTML = `
                    <div>
                        <p class="text-white text-sm">${description}</p>
                    </div>
                    <div class="self-end sm:self-center">
                        <button data-id="${docChange.id}" class="edit-pending-btn bg-blue-600 text-white px-3 py-1 text-xs rounded hover:bg-blue-700">Editar</button>
                    </div>
                `;
                listEl.appendChild(div);
            });
            
            document.querySelectorAll('.edit-pending-btn').forEach(btn => btn.addEventListener('click', handleEdit));
        }

        async function showReviewNeededManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `<h2 class="text-2xl font-semibold text-white mb-4">Itens a Precisar de Revisão</h2><div id="review-list" class="max-h-[70vh] overflow-y-auto space-y-4 pr-2"></div>`;
            
            const listEl = document.getElementById('review-list');
            listEl.innerHTML = '<p class="text-gray-400">A carregar...</p>';
            
            const q = query(collection(db, "pendingChanges"), 
                where("status", "==", "review_needed"),
                where("proposedBy", "==", currentUser.data.email)
            );
            const snapshot = await getDocs(q);
            
            listEl.innerHTML = snapshot.empty ? '<p class="text-gray-400">Não há itens a precisar da sua revisão.</p>' : '';
            
            snapshot.docs.forEach(docChange => {
                const change = docChange.data();
                const div = document.createElement('div');
                div.className = 'bg-gray-800 border border-yellow-500/50 p-4 rounded-lg flex flex-col gap-3';
                
                const actionText = change.action === 'create' ? 'criação' : 'atualização';
                const typeText = { challenge: 'Desafio', level: 'Nível', achievement: 'Conquista'}[change.type] || 'Item';
                let description = `Proposta de ${actionText} de ${typeText}: <strong class="text-indigo-300">${change.data.name}</strong>`;
                let reviewNotes = `<div class="mt-2 p-3 bg-yellow-900/50 rounded-md"><p class="text-sm font-semibold text-yellow-300">Nota do Admin (${change.reviewedBy}):</p><p class="text-sm text-yellow-200">${change.reviewNotes}</p></div>`;
                
                div.innerHTML = `
                    <div>
                        <p class="text-white text-sm">${description}</p>
                        ${reviewNotes}
                    </div>
                    <div class="self-end">
                        <button data-id="${docChange.id}" class="edit-review-btn bg-blue-600 text-white px-3 py-1 text-xs rounded hover:bg-blue-700">Editar e Reenviar</button>
                    </div>
                `;
                listEl.appendChild(div);
            });
            
            document.querySelectorAll('.edit-review-btn').forEach(btn => btn.addEventListener('click', handleEdit));
        }

        async function showPendingChangesManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `<h2 class="text-2xl font-semibold text-white mb-4">Aprovações Pendentes</h2><div id="pending-list" class="max-h-[70vh] overflow-y-auto space-y-2 pr-2"></div>`;
            
            const listEl = document.getElementById('pending-list');
            listEl.innerHTML = '<p class="text-gray-400">A carregar...</p>';
            
            const q = query(collection(db, "pendingChanges"), where("status", "==", "pending"));
            const snapshot = await getDocs(q);
            const pendingDocs = snapshot.docs;
            pendingDocs.sort((a, b) => (b.data().timestamp?.toDate() || 0) - (a.data().timestamp?.toDate() || 0));

            listEl.innerHTML = pendingDocs.length === 0 ? '<p class="text-gray-400">Nenhuma alteração pendente.</p>' : '';
            
            pendingDocs.forEach(docChange => {
                const change = docChange.data();
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4';
                
                const actionText = change.action === 'create' ? 'criação' : 'atualização';
                const typeText = { challenge: 'Desafio', level: 'Nível', achievement: 'Conquista'}[change.type] || 'Item';
                let description = `Proposta de ${actionText} de ${typeText}: <strong class="text-indigo-300">${change.data.name}</strong><br><em class="text-xs text-gray-400">Por: ${change.proposedBy}</em>`;
                
                div.innerHTML = `
                    <div><p class="text-white text-sm">${description}</p></div>
                    <div class="flex-shrink-0 flex gap-2">
                        <button data-id="${docChange.id}" class="review-change-btn bg-yellow-600 text-white px-3 py-1 text-xs rounded hover:bg-yellow-700">Revisão</button>
                        <button data-id="${docChange.id}" class="edit-change-btn bg-blue-600 text-white px-3 py-1 text-xs rounded hover:bg-blue-700">Editar</button>
                        <button data-id="${docChange.id}" class="approve-change-btn bg-green-600 text-white px-3 py-1 text-xs rounded hover:bg-green-700">Aprovar</button>
                        <button data-id="${docChange.id}" class="reject-change-btn bg-red-600 text-white px-3 py-1 text-xs rounded hover:bg-red-700">Rejeitar</button>
                    </div>
                `;
                listEl.appendChild(div);
            });
            
            document.querySelectorAll('.review-change-btn').forEach(btn => btn.addEventListener('click', confirmReviewRequest));
            document.querySelectorAll('.edit-change-btn').forEach(btn => btn.addEventListener('click', handleEdit));
            document.querySelectorAll('.approve-change-btn').forEach(btn => btn.addEventListener('click', handleApproval));
            document.querySelectorAll('.reject-change-btn').forEach(btn => btn.addEventListener('click', handleRejection));
        }

        function confirmReviewRequest(e) {
            const changeId = e.target.dataset.id;
            const modalContent = `
                <p class="text-gray-300 mb-4">Por favor, escreva uma breve nota para o moderador explicando o que precisa ser corrigido.</p>
                <textarea id="review-notes-input" class="w-full p-2 bg-gray-900 text-white border border-gray-600 rounded-lg" rows="3" placeholder="Ex: A pontuação parece muito alta..."></textarea>
                <div class="flex justify-end gap-4 mt-4">
                    <button onclick="document.getElementById('review-request-modal').remove()" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Cancelar</button>
                    <button id="confirm-review-request-btn" class="bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700">Enviar para Revisão</button>
                </div>
            `;
            createModal('review-request-modal', 'Pedir Revisão', modalContent, 'max-w-md');

            document.getElementById('confirm-review-request-btn').addEventListener('click', () => {
                const notes = document.getElementById('review-notes-input').value;
                if (!notes.trim()) {
                    alert('Por favor, adicione uma nota de revisão.');
                    return;
                }
                handleReviewRequest(changeId, notes);
                document.getElementById('review-request-modal').remove();
            });
        }

        async function handleReviewRequest(changeId, notes) {
            const changeDocRef = doc(db, "pendingChanges", changeId);
            try {
                await updateDoc(changeDocRef, { 
                    status: 'review_needed', 
                    reviewNotes: notes, 
                    reviewedBy: currentUser.data.email 
                });
                createModal('success-modal', 'Sucesso', '<p class="text-gray-300">A proposta foi enviada de volta para revisão.</p>', 'max-w-sm');
                showPendingChangesManagement();
            } catch (error) {
                console.error("Erro ao pedir revisão:", error);
                createModal('error-modal', 'Erro', '<p class="text-gray-300">Ocorreu um erro. Verifique a consola.</p>', 'max-w-sm');
            }
        }

        async function handleEdit(e) {
            const changeId = e.target.dataset.id;
            const changeDocRef = doc(db, "pendingChanges", changeId);
            const changeDocSnap = await getDoc(changeDocRef);

            if (!changeDocSnap.exists()) {
                return createModal('error-modal', 'Erro', '<p class="text-gray-300">Proposta não encontrada.</p>', 'max-w-sm');
            }

            const changeData = changeDocSnap.data();
            
            if (changeData.type === 'challenge') {
                openChallengeModal(null, changeData, changeId);
            } else if (changeData.type === 'level') {
                openLevelModal(null, changeData, changeId);
            } else if (changeData.type === 'achievement') {
                openAchievementModal(null, changeData, changeId);
            }
        }

        async function handleApproval(e) {
            const changeId = e.target.dataset.id;
            const changeDocRef = doc(db, "pendingChanges", changeId);
            const changeDocSnap = await getDoc(changeDocRef);

            if (!changeDocSnap.exists()) return createModal('error-modal', 'Erro', '<p class="text-gray-300">Proposta não encontrada.</p>', 'max-w-sm');

            const change = changeDocSnap.data();
            const targetCollection = change.type + 's'; // ex: 'challenges', 'levels'
            
            try {
                await setDoc(doc(db, targetCollection, change.targetId), change.data);
                await updateDoc(changeDocRef, { status: 'approved', approvedBy: currentUser.data.email });
                createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta aprovada e publicada!</p>', 'max-w-sm');
                showPendingChangesManagement(); // Recarrega a lista
            } catch (error) {
                console.error("Erro ao aprovar:", error);
                createModal('error-modal', 'Erro', '<p class="text-gray-300">Ocorreu um erro ao aprovar. Verifique o console.</p>', 'max-w-sm');
            }
        }

        async function handleRejection(e) {
            const changeId = e.target.dataset.id;
            const changeDocRef = doc(db, "pendingChanges", changeId);
            try {
                await updateDoc(changeDocRef, { status: 'rejected', rejectedBy: currentUser.data.email });
                 createModal('success-modal', 'Sucesso', '<p class="text-gray-300">Proposta rejeitada.</p>', 'max-w-sm');
                showPendingChangesManagement(); // Recarrega a lista
            } catch (error) {
                console.error("Erro ao rejeitar:", error);
                createModal('error-modal', 'Erro', '<p class="text-gray-300">Ocorreu um erro ao rejeitar. Verifique o console.</p>', 'max-w-sm');
            }
        }

        // --- GERENCIAMENTO DE TEMAS (Admin)---
        async function showThemesManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Temas da Interface</h2>
                    <button id="add-new-theme-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Adicionar Tema</button>
                </div>
                <div id="themes-list" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>`;
            document.getElementById('add-new-theme-btn').addEventListener('click', () => openThemeModal());
            await loadThemes();
        }

        async function loadThemes() {
            const listEl = document.getElementById('themes-list');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const querySnapshot = await getDocs(collection(db, "themes"));
            listEl.innerHTML = querySnapshot.empty ? '<p class="text-gray-400">Nenhum tema cadastrado.</p>' : '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-3 rounded flex justify-between items-center';
                const obtainMethodText = data.obtainMethod === 'shop' 
                    ? `<span class="text-xs bg-yellow-500 text-white px-2 py-1 rounded-full ml-2">${data.price} pts</span>`
                    : `<span class="text-xs bg-cyan-500 text-white px-2 py-1 rounded-full ml-2">Nível: ${allLevelsData.find(l => l.id === data.levelId)?.name || 'N/A'}</span>`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-8 rounded border border-gray-500 flex" style="background:${data.colors.bg};">
                           <span class="w-1/3 h-full" style="background:${data.colors.primary};"></span>
                           <span class="w-1/3 h-full" style="background:${data.colors.cardBg};"></span>
                           <span class="w-1/3 h-full" style="background:${data.colors.text};"></span>
                        </div>
                        <div>
                           <span class="text-white font-semibold">${data.name}</span>
                           ${obtainMethodText}
                        </div>
                    </div>
                    <div>
                         <button data-id="${doc.id}" class="delete-theme-btn bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Excluir</button>
                    </div>`;
                listEl.appendChild(div);
            });
            document.querySelectorAll('.delete-theme-btn').forEach(btn => btn.addEventListener('click', (e) => deleteDoc(doc(db, "themes", e.target.dataset.id)).then(loadThemes)));
        }

        async function openThemeModal() {
            const levelOptions = allLevelsData.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            createModal('theme-modal', 'Gerenciar Tema', `
                <form id="add-theme-form" class="space-y-4">
                    <input type="text" id="theme-name" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Nome do Tema">
                    <input type="text" id="theme-description" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Descrição (ex: Um tema escuro e elegante)">
                     <div class="border-t border-gray-600 pt-4">
                          <label class="text-sm font-medium text-gray-300">Método de Obtenção</label>
                          <select id="theme-obtain-method" class="w-full mt-2 p-3 bg-gray-700 text-white border border-gray-600 rounded-lg">
                               <option value="shop">Loja</option>
                               <option value="level">Recompensa de Nível</option>
                          </select>
                     </div>
                    <div id="theme-shop-fields">
                          <input type="number" id="theme-price" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Preço na Loja">
                    </div>
                    <div id="theme-level-fields" class="hidden">
                             <select id="theme-level-id" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg">
                               <option value="">Selecione o nível</option>
                               ${levelOptions}
                             </select>
                    </div>
                    <div class="border-t border-gray-600 pt-4">
                             <label class="text-sm font-medium text-gray-300">Cores do Tema</label>
                             <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                                  <div class="flex flex-col items-center"><label>Fundo</label><input type="color" id="theme-color-bg" value="#0d1b2a" class="w-full h-10 p-1 bg-gray-700 border border-gray-600 rounded-lg"></div>
                                  <div class="flex flex-col items-center"><label>Texto</label><input type="color" id="theme-color-text" value="#FFFFFF" class="w-full h-10 p-1 bg-gray-700 border border-gray-600 rounded-lg"></div>
                                  <div class="flex flex-col items-center"><label>Primária</label><input type="color" id="theme-color-primary" value="#6366f1" class="w-full h-10 p-1 bg-gray-700 border border-gray-600 rounded-lg"></div>
                                  <div class="flex flex-col items-center"><label>Card</label><input type="color" id="theme-color-cardBg" value="#1a2634" class="w-full h-10 p-1 bg-gray-700 border border-gray-600 rounded-lg"></div>
                             </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Salvar Tema</button>
                </form>
            `, 'max-w-2xl');
            
            const obtainMethodSelect = document.getElementById('theme-obtain-method');
            const shopFields = document.getElementById('theme-shop-fields');
            const levelFields = document.getElementById('theme-level-fields');
            
            const toggleObtainFields = () => {
                const method = obtainMethodSelect.value;
                shopFields.classList.toggle('hidden', method !== 'shop');
                levelFields.classList.toggle('hidden', method !== 'level');
            };
            obtainMethodSelect.addEventListener('change', toggleObtainFields);
            toggleObtainFields();

            document.getElementById('add-theme-form').addEventListener('submit', saveTheme);
        }

        async function saveTheme(e) {
            e.preventDefault();
            const obtainMethod = document.getElementById('theme-obtain-method').value;
            const data = {
                name: document.getElementById('theme-name').value,
                description: document.getElementById('theme-description').value,
                obtainMethod,
                price: obtainMethod === 'shop' ? parseInt(document.getElementById('theme-price').value) || 0 : null,
                levelId: obtainMethod === 'level' ? document.getElementById('theme-level-id').value : null,
                colors: {
                    bg: document.getElementById('theme-color-bg').value,
                    text: document.getElementById('theme-color-text').value,
                    primary: document.getElementById('theme-color-primary').value,
                    cardBg: document.getElementById('theme-color-cardBg').value,
                }
            };
            
            if (obtainMethod === 'level' && !data.levelId) {
                return alert('Por favor, selecione o nível para a recompensa de tema.');
            }

            await addDoc(collection(db, "themes"), data);
            document.getElementById('theme-modal').remove();
            await loadThemes();
        }

        // --- GERENCIAMENTO DE CÓDIGOS ---
        async function showCodesManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Códigos de Bônus</h2>
                    <button id="add-new-code-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Criar Código</button>
                </div>
                <div id="codes-list" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>`;
            document.getElementById('add-new-code-btn').addEventListener('click', () => openCodeModal());
            await loadCodes();
        }

        async function loadCodes() {
            const listEl = document.getElementById('codes-list');
            listEl.innerHTML = '<p class="text-gray-400">Carregando...</p>';
            const q = query(collection(db, "specialCodes"), orderBy("expiresAt", "desc"));
            const querySnapshot = await getDocs(q);
            listEl.innerHTML = querySnapshot.empty ? '<p class="text-gray-400">Nenhum código criado.</p>' : '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const div = document.createElement('div');
                const isExpired = data.expiresAt.toDate() < new Date();
                const usesText = data.totalUses === -1 ? 'Ilimitado' : `${data.usesLeft}/${data.totalUses}`;
                div.className = `bg-gray-700 p-3 rounded flex justify-between items-center ${isExpired ? 'opacity-50' : ''}`;
                
                let effectText = '';
                if (data.effectType === 'SCORE_MULTIPLIER') {
                    effectText = `Pontos x${data.effectValue} por ${data.durationMinutes} min`;
                } else if (data.effectType === 'PAUSE_TIMER') {
                    effectText = `Pausa o tempo por ${data.effectValue} min`;
                }

                div.innerHTML = `
                    <div>
                        <p class="font-mono text-lg text-yellow-400">${data.code}</p>
                        <p class="text-sm text-gray-300">Efeito: ${effectText}</p>
                        <p class="text-xs text-gray-400">Usos: ${usesText} | Expira em: ${data.expiresAt.toDate().toLocaleDateString()}</p>
                    </div>
                    <button data-id="${doc.id}" class="delete-code-btn bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Excluir</button>`;
                listEl.appendChild(div);
            });
            document.querySelectorAll('.delete-code-btn').forEach(btn => btn.addEventListener('click', (e) => deleteDoc(doc(db, "specialCodes", e.target.dataset.id)).then(loadCodes)));
        }

        function openCodeModal() {
            createModal('code-modal', 'Criar Novo Código', `
                <form id="add-code-form" class="space-y-4">
                    <input type="text" id="code-string" required class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg font-mono tracking-widest" placeholder="CÓDIGO (ex: BONUSXP5)">
                    
                    <div>
                        <label class="text-sm font-medium text-gray-300">Tipo de Efeito</label>
                        <select id="code-effect-type" class="w-full mt-1 p-3 bg-gray-700 text-white border border-gray-600 rounded-lg">
                            <option value="SCORE_MULTIPLIER">Multiplicador de Pontos</option>
                            <option value="PAUSE_TIMER">Pausar Tempo do Desafio</option>
                        </select>
                    </div>

                    <div id="effect-fields-score-multiplier">
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                              <div>
                                   <label class="text-sm font-medium text-gray-300">Multiplicador de Pontos</label>
                                   <input type="number" step="0.1" id="code-score-multiplier-value" class="w-full mt-1 p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Ex: 2 para 2x">
                              </div>
                              <div>
                                   <label class="text-sm font-medium text-gray-300">Duração (minutos)</label>
                                   <input type="number" id="code-score-multiplier-duration" class="w-full mt-1 p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Ex: 60">
                              </div>
                         </div>
                    </div>
                    
                    <div id="effect-fields-pause-timer" class="hidden">
                        <div>
                            <label class="text-sm font-medium text-gray-300">Pausar por (minutos)</label>
                            <input type="number" id="code-pause-duration" class="w-full mt-1 p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" placeholder="Ex: 5">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label class="text-sm font-medium text-gray-300">Usos Totais (-1 para ilimitado)</label>
                            <input type="number" id="code-uses" required class="w-full mt-1 p-3 bg-gray-700 text-white border border-gray-600 rounded-lg" value="-1">
                          </div>
                          <div>
                            <label class="text-sm font-medium text-gray-300">Data de Expiração</label>
                            <input type="date" id="code-expires" required class="w-full mt-1 p-3 bg-gray-700 text-white border border-gray-600 rounded-lg">
                          </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Salvar Código</button>
                </form>
            `, 'max-w-lg');

            const effectTypeSelect = document.getElementById('code-effect-type');
            const scoreFields = document.getElementById('effect-fields-score-multiplier');
            const pauseFields = document.getElementById('effect-fields-pause-timer');

            function toggleEffectFields() {
                if (effectTypeSelect.value === 'SCORE_MULTIPLIER') {
                    scoreFields.classList.remove('hidden');
                    pauseFields.classList.add('hidden');
                } else {
                    scoreFields.classList.add('hidden');
                    pauseFields.classList.remove('hidden');
                }
            }
            effectTypeSelect.addEventListener('change', toggleEffectFields);
            toggleEffectFields();

            document.getElementById('add-code-form').addEventListener('submit', saveCode);
        }

        async function saveCode(e) {
            e.preventDefault();
            const codeString = document.getElementById('code-string').value.toUpperCase();
            const uses = parseInt(document.getElementById('code-uses').value);
            const expirationDate = new Date(document.getElementById('code-expires').value);
            expirationDate.setHours(23, 59, 59);

            const effectType = document.getElementById('code-effect-type').value;
            let effectValue, durationMinutes;

            if (effectType === 'SCORE_MULTIPLIER') {
                effectValue = parseFloat(document.getElementById('code-score-multiplier-value').value);
                durationMinutes = parseInt(document.getElementById('code-score-multiplier-duration').value);
            } else if (effectType === 'PAUSE_TIMER') {
                effectValue = parseInt(document.getElementById('code-pause-duration').value);
                durationMinutes = 0; // Not applicable
            }

            const data = {
                code: codeString,
                effectType,
                effectValue,
                durationMinutes,
                totalUses: uses,
                usesLeft: uses,
                createdAt: serverTimestamp(),
                expiresAt: Timestamp.fromDate(expirationDate)
            };
            
            await setDoc(doc(db, "specialCodes", codeString), data);
            document.getElementById('code-modal').remove();
            await loadCodes();
        }

        // --- GERENCIAMENTO DE CONFIGURAÇÕES GERAIS ---
        async function showSettingsManagement() {
            dynamicContent.classList.remove('hidden');
            dynamicContent.innerHTML = `
                <h2 class="text-2xl font-semibold text-white mb-4">Configurações Gerais</h2>
                <div class="border-t border-red-500/30 pt-4 mt-4">
                    <h4 class="text-lg font-semibold text-red-400 mb-2">Zona de Perigo</h4>
                    <div class="p-4 bg-black/20 rounded-lg">
                        <p class="text-sm text-gray-300 mb-4">A ação abaixo é extremamente destrutiva e irá apagar TODOS os dados de usuários e progresso. Não pode ser desfeita.</p>
                        <button id="reset-all-data-btn" class="bg-red-800 hover:bg-red-900 text-white font-bold py-3 px-6 rounded-lg">Resetar Toda a Aplicação</button>
                    </div>
                </div>
            `;
            document.getElementById('reset-all-data-btn').addEventListener('click', confirmFullReset);
        }

        function confirmFullReset() {
            const confirmationPhrase = "APAGAR TUDO";
            createModal('confirm-full-reset-modal', 'REDEFINIÇÃO TOTAL DO SISTEMA', `
                <p class="text-red-400 font-bold mb-4">ATENÇÃO: AÇÃO IRREVERSÍVEL</p>
                <p class="text-gray-300 mb-4">Você está prestes a apagar TODOS os dados de usuários, tentativas, compras e conquistas. O sistema voltará ao estado inicial.</p>
                <p class="text-gray-300 mb-4">Para confirmar, digite <strong class="text-yellow-400">${confirmationPhrase}</strong> no campo abaixo:</p>
                <input type="text" id="full-reset-confirmation-input" class="w-full p-2 bg-gray-900 text-white border border-gray-600 rounded-lg mb-6">
                <div class="flex justify-end gap-4">
                    <button onclick="document.getElementById('confirm-full-reset-modal').remove()" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">Cancelar</button>
                    <button id="confirm-full-reset-btn" class="bg-red-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-900 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Confirmar Redefinição Total</button>
                </div>
            `, 'max-w-lg');
            
            const input = document.getElementById('full-reset-confirmation-input');
            const confirmBtn = document.getElementById('confirm-full-reset-btn');

            input.addEventListener('input', () => {
                confirmBtn.disabled = input.value !== confirmationPhrase;
            });

            confirmBtn.addEventListener('click', async () => {
                confirmBtn.textContent = 'Apagando...';
                confirmBtn.disabled = true;
                await resetEntireSystem();
                document.getElementById('confirm-full-reset-modal').remove();
            });
        }

        async function resetEntireSystem() {
            try {
                // Ao apagar a coleção 'users', todas as subcoleções (como conquistas e itens) são apagadas automaticamente pelo Firestore.
                const collectionsToWipe = ['users', 'attempts', 'purchaseNotifications', 'pendingChanges'];
                for (const coll of collectionsToWipe) {
                    const snapshot = await getDocs(collection(db, coll));
                    await Promise.all(snapshot.docs.map(d => deleteDoc(d.ref)));
                }
                createModal('success-modal', 'Sistema Redefinido', `<p class="text-gray-300">Todos os dados de progresso e usuários foram apagados com sucesso.</p>`, 'max-w-sm');
                await showDashboard();
            } catch (error) {
                console.error("Erro na redefinição total do sistema: ", error);
                createModal('error-modal', 'Erro', `<p class="text-gray-300">Ocorreu um erro na redefinição total. Verifique o console.</p>`, 'max-w-sm');
            }
        }
    </script>
</body>
</html>

